<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BITÁCORA ELECTRÓNICA PARA MONITOREO DE LOGÍSTICA</title>

    <!-- UI -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Libs -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.7/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.7/plugin/customParseFormat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.7/plugin/utc.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="js/downloadKpisTabAsHTML.js"></script>
    <script src="js/downloadInformeTabsHTML.js"></script>

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: Inter, sans-serif;
        background: #f3f4f6;
      }
      .tab-btn {
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem 0.5rem 0 0;
        font-weight: 600;
        cursor: pointer;
        transition: 0.2s;
      }
      .tab-active {
        background: #fff;
        color: #111827;
        border-bottom: 3px solid #4f46e5;
      }
      .tab-content {
        background: #fff;
        padding: 1.5rem;
        border-radius: 0 0.5rem 0.5rem 0.5rem;
        min-height: 520px;
      }
      .modal {
        background: rgba(0, 0, 0, 0.45);
      }
      .registro-board {
        display: grid;
        grid-template-columns: 1fr repeat(5, minmax(180px, 1fr));
        gap: 1px;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        overflow: hidden;
      }
      .board-row {
        display: contents;
      }
      .board-cell {
        padding: 1rem;
        background: #fff;
        border-right: 1px solid #e5e7eb;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        font-size: 0.875rem;
      }
      .board-row:first-child .board-cell {
        background: #e5e7eb;
        font-weight: 700;
      }
      .estatus-verde {
        background: #d1fae5;
        color: #065f46;
      }
      .estatus-rojo {
        background: #fee2e2;
        color: #991b1b;
      }
      .estatus-en-ruta {
        background: #fef3c7;
        color: #92400e;
      }
      .estatus-cancelado {
        background: #dbeafe;
        color: #1e40af;
      }
      .task-cell {
        background: #f9fafb;
        color: #4b5563;
      }
      @media (max-width: 1024px) {
        .registro-board {
          grid-template-columns: 1fr;
        }
        .board-row {
          display: block;
          margin-bottom: 1rem;
          border: 1px solid #e5e7eb;
          border-radius: 0.5rem;
          overflow: hidden;
        }
        .board-row:first-child {
          display: none;
        }
        .board-cell {
          border-right: none;
          border-bottom: 1px solid #e5e7eb;
          align-items: flex-start;
          text-align: left;
        }
        .board-cell::before {
          content: attr(data-label);
          display: block;
          font-weight: 800;
          color: #4b5563;
          font-size: 0.75rem;
          margin-bottom: 0.25rem;
        }
        .unit-cell {
          background: #e5e7eb !important;
        }
      }

      /* Clases de Incidencia */
      .incidencia-rojo {
        background-color: #fee2e2;
        color: #ef4444;
        border-left: 4px solid #ef4444;
      }
      .incidencia-naranja {
        background-color: #ffedd5;
        color: #f97316;
        border-left: 4px solid #f97316;
      }
      .incidencia-verde {
        background-color: #d1fae5;
        color: #10b981;
        border-left: 4px solid #10b981;
      }
    </style>

    <script>
      dayjs.extend(dayjs_plugin_customParseFormat);
      dayjs.extend(dayjs_plugin_utc);
    </script>
  </head>

  <body>
    <div class="container mx-auto p-4 md:p-8">
      <!-- Header -->
      <header class="mb-6 bg-white p-6 rounded-xl shadow-md text-center">
        <img
          src="https://i.postimg.cc/CY2DgtbK/A-COLOR.png"
          alt="Logo"
          class="h-16 mx-auto mb-4"
        />
        <h1 class="text-3xl font-extrabold text-gray-900">
          BITÁCORA ELECTRÓNICA PARA MONITOREO DE LOGÍSTICA
        </h1>
        <p class="text-sm text-gray-500 mt-1">
          Centro de Monitoreo GEO-24 de TRACKER MEXICO GPS
        </p>
        <p class="text-sm text-gray-700">
          Desarrollo realizado por el Departamento de IA 2025
        </p>
      </header>

      <!-- Controles -->
      <div
        class="flex items-center justify-between bg-white p-4 rounded-xl shadow-md mb-6"
      >
        <div class="flex items-center gap-3">
          <label for="date-filter" class="font-medium text-gray-700"
            >Fecha de Despacho:</label
          >
          <input
            type="date"
            id="date-filter"
            onchange="filterByDate()"
            class="p-2 border rounded-lg"
          />
        </div>
        <div
          id="cliente-display"
          class="text-lg font-semibold text-gray-700 text-center"
        >
          Cliente:
          <span id="cliente-display-name" class="text-gray-900"> N/A </span>
        </div>
        <button
          onclick="exportUpdatedSheet()"
          class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700"
        >
          Exportar XLSX
        </button>
      </div>

      <!-- Tabs -->
      <div class="flex border-b border-gray-300 overflow-x-auto">
        <button
          id="tab-btn-0"
          class="tab-btn tab-active"
          onclick="changeTab(0)"
        >
          Datos Generales
        </button>
        <button
          id="tab-btn-1"
          class="tab-btn text-gray-500"
          onclick="changeTab(1)"
        >
          Rutas & Origen/Destino
        </button>
        <button
          id="tab-btn-2"
          class="tab-btn text-gray-500"
          onclick="changeTab(2)"
        >
          Seguimiento Detallado
        </button>
        <button
          id="tab-btn-3"
          class="tab-btn text-gray-500"
          onclick="changeTab(3)"
        >
          Matriz de Registro
        </button>
        <button
          id="tab-btn-4"
          class="tab-btn text-gray-500"
          onclick="changeTab(4)"
        >
          KPIs de Cumplimiento
        </button>
        <button
          id="tab-btn-5"
          class="tab-btn text-gray-500"
          onclick="changeTab(5)"
        >
          Informe Ejecutivo
        </button>
        <button
          id="tab-btn-6"
          class="tab-btn text-gray-500"
          onclick="changeTab(6)"
        >
          Informes Guardados
        </button>
      </div>

      <div class="tab-content shadow-lg">
        <!-- TAB 0 -->
        <div id="tab-0" class="tab-content-item">
          <h2 class="text-2xl font-semibold mb-4 text-gray-800">
            Datos Generales de Despachos
          </h2>

          <!-- Filtros para Datos Generales -->
          <div
            class="flex flex-wrap items-center gap-4 mb-6 p-4 border rounded-lg bg-gray-50"
          >
            <div class="flex items-center gap-2">
              <label
                for="filtro-unidad-dg"
                class="text-sm font-medium text-gray-700"
                >Unidad:</label
              >
              <select
                id="filtro-unidad-dg"
                onchange="renderDatosGenerales()"
                class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-blue-500 focus:border-blue-500"
              >
                <option value="">Todas las unidades</option>
              </select>
            </div>
            <div class="flex items-center gap-2">
              <label
                for="filtro-max-tramos"
                class="text-sm font-medium text-gray-700"
                >Máx. tramos:</label
              >
              <select
                id="filtro-max-tramos"
                onchange="renderDatosGenerales()"
                class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-blue-500 focus:border-blue-500"
              >
                <option value="0">Sin límite</option>
                <option value="1">1 tramo</option>
                <option value="2">2 tramos</option>
                <option value="3" selected>3 tramos</option>
                <option value="5">5 tramos</option>
                <option value="10">10 tramos</option>
              </select>
            </div>
            <div class="flex items-center gap-2">
              <label
                for="filtro-cliente-dg"
                class="text-sm font-medium text-gray-700"
                >Cliente:</label
              >
              <select
                id="filtro-cliente-dg"
                onchange="renderDatosGenerales()"
                class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-blue-500 focus:border-blue-500"
              >
                <option value="">Todos los clientes</option>
              </select>
            </div>
            <button
              onclick="limpiarFiltrosDatosGenerales()"
              class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-2 rounded-lg text-sm transition"
            >
              Limpiar filtros
            </button>
            <span
              id="contador-datos-generales"
              class="ml-auto text-sm text-gray-600"
            ></span>
          </div>

          <div
            id="datos-generales-container"
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
          ></div>
        </div>

        <!-- TAB 1 -->
        <div id="tab-1" class="tab-content-item hidden">
          <h2 class="text-2xl font-semibold mb-4 text-gray-800">
            Origen y Destino de Unidades
          </h2>
          <div
            id="origen-destino-container"
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
          ></div>
        </div>

        <!-- TAB 2 -->
        <div id="tab-2" class="tab-content-item hidden">
          <h2 class="text-2xl font-semibold mb-4 text-gray-800">
            Seguimiento y Registro de Tiempos
          </h2>

          <div
            class="flex flex-wrap items-center justify-between gap-3 mb-6 p-4 border rounded-lg bg-gray-50"
          >
            <div class="flex items-center flex-grow max-w-xl gap-3">
              <select
                id="unidad-selector"
                class="p-2 border rounded-lg flex-grow"
                onchange="handleUnidadSelection(event)"
              ></select>
              <button
                id="consulta-btn"
                onclick="showUnitData()"
                disabled
                class="bg-blue-600 text-white px-4 py-2 rounded-lg disabled:bg-blue-300 hover:bg-blue-700"
              >
                Datos
              </button>
            </div>

            <div class="flex items-center gap-2">
              <!-- Teléfono/911 -->
              <!-- <button
                type="button"
                onclick="openEmergency911Modal()"
                title="Números de Emergencia 911"
                class="bg-gray-200 text-gray-700 p-2 rounded-lg hover:bg-red-500 hover:text-white transition flex items-center justify-center"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="22"
                  height="22"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path
                    d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-3.1-3.1A19.79 19.79 0 0 1 2 4.18 2 2 0 0 1 4.18 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
                  />
                </svg>
              </button> -->

              <!-- Contactos -->
              <button
                type="button"
                onclick="openEmergencyContactsModal()"
                title="Contactos de Emergencia"
                class="bg-gray-200 text-gray-700 p-2 rounded-lg hover:bg-emerald-600 hover:text-white transition flex items-center justify-center"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="22"
                  height="22"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M4 12a8 8 0 0 1 16 0" />
                  <path d="M4 12v3a3 3 0 0 0 3 3h1" />
                  <path d="M20 12v3a3 3 0 0 1-3 3h-1" />
                  <path d="M8 19c1.5 1.5 6.5 1.5 8 0" />
                  <path d="M7 12v-1a5 5 0 0 1 10 0v1" />
                </svg>
              </button>
            </div>
          </div>

          <div
            id="seguimiento-form-container"
            class="hidden bg-white p-6 rounded-xl border"
          ></div>
        </div>

        <!-- TAB 3 -->
        <div id="tab-3" class="tab-content-item hidden">
          <h2 class="text-2xl font-semibold mb-4 text-gray-800">
            Matriz de Tiempos Programados vs. Reales
          </h2>
          <div
            class="flex flex-wrap items-center justify-between gap-3 mb-6 p-4 border rounded-lg bg-gray-50"
          >
            <div class="flex flex-wrap items-center gap-4">
              <div class="flex items-center flex-grow max-w-xl gap-3">
                <label
                  for="registro-unidad-filter"
                  class="font-medium text-gray-700"
                  >Filtrar por estatus:</label
                >
                <select
                  id="registro-unidad-filter"
                  onchange="renderRegistroDespacho()"
                  class="p-2 border rounded-lg ml-2"
                ></select>
              </div>
              <div class="flex items-center flex-grow max-w-xl gap-3">
                <label
                  for="registro-unidades-filter"
                  class="font-medium text-gray-700"
                  >Filtrar por unidad:</label
                >
                <select
                  id="registro-unidades-filter"
                  onchange="renderRegistroDespacho()"
                  class="p-2 border rounded-lg ml-2"
                >
                  <option value="all">Todas las unidades</option>
                </select>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <button
                type="button"
                onclick="openEmergency911Modal()"
                title="Números de Emergencia 911"
                class="bg-gray-200 text-gray-700 p-2 rounded-lg hover:bg-red-500 hover:text-white transition flex items-center justify-center"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="22"
                  height="22"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path
                    d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-3.1-3.1A19.79 19.79 0 0 1 2 4.18 2 2 0 0 1 4.18 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
                  />
                </svg>
              </button>
            </div>
          </div>
          <div id="registro-board-container" class="overflow-x-auto pb-4"></div>
        </div>

        <!-- TAB 4 -->
        <div id="tab-4" class="tab-content-item hidden">
          <div class="flex items-center justify-between flex-wrap gap-3 mb-4">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">
              KPIs de Cumplimiento
            </h2>

            <button
              type="button"
              onclick="downloadKpisTabAsHTML()"
              class="bg-gray-900 text-white px-4 py-2 rounded-lg hover:bg-gray-800"
              title="Descarga esta pestaña (KPIs + gráficos) en HTML"
            >
              Descargar HTML
            </button>
          </div>

          <div class="grid grid-cols-2 lg:grid-cols-6 gap-6 mb-8">
            <div class="bg-gray-800 text-white p-5 rounded-xl shadow-xl">
              <p class="text-sm font-medium opacity-80">Total Despachos</p>
              <p id="kpi-total-despachos" class="text-3xl font-bold mt-1">0</p>
            </div>
            <div class="bg-green-600 text-white p-5 rounded-xl shadow-xl">
              <p class="text-sm font-medium opacity-80">A Tiempo</p>
              <p id="kpi-despachos-a-tiempo" class="text-3xl font-bold mt-1">
                0
              </p>
            </div>
            <div class="bg-red-600 text-white p-5 rounded-xl shadow-xl">
              <p class="text-sm font-medium opacity-80">Con Retraso</p>
              <p id="kpi-despachos-retraso" class="text-3xl font-bold mt-1">
                0
              </p>
            </div>
            <div class="bg-yellow-600 text-white p-5 rounded-xl shadow-xl">
              <p class="text-sm font-medium opacity-80">En Ruta</p>
              <p id="kpi-despachos-en-ruta" class="text-3xl font-bold mt-1">
                0
              </p>
            </div>
            <div class="bg-blue-600 text-white p-5 rounded-xl shadow-xl">
              <p class="text-sm font-medium opacity-80">Programados</p>
              <p id="kpi-despachos-programados" class="text-3xl font-bold mt-1">
                0
              </p>
            </div>
            <div class="bg-blue-400 text-white p-5 rounded-xl shadow-xl">
              <p class="text-sm font-medium opacity-80">Cancelados</p>
              <p id="kpi-despachos-cancelados" class="text-3xl font-bold mt-1">
                0
              </p>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
            <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-md border">
              <h3 class="font-semibold text-lg mb-4">Estado de Despachos</h3>
              <canvas id="kpi-cumplimiento-chart"></canvas>
            </div>
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md border">
              <h3 class="font-semibold text-lg mb-4">Incidencias</h3>
              <canvas id="kpi-incidencias-chart"></canvas>
            </div>
          </div>
        </div>

        <!-- TAB 5 -->
        <div id="tab-5" class="tab-content-item hidden">
          <div class="flex items-center justify-between flex-wrap gap-3 mb-4">
            <h2 class="text-2xl font-semibold text-gray-800">
              Informe Ejecutivo
            </h2>

            <button
              type="button"
              onclick="downloadInformeTabAsHTML()"
              class="bg-gray-900 text-white px-4 py-2 rounded-lg hover:bg-gray-800"
              title="Descarga esta pestaña (Informe Ejecutivo) en HTML"
            >
              Descargar HTML
            </button>
          </div>
          <!-- Filtro de Informe Ejecutivo (aplicado a Resumen, Detalle e Incidencias) -->
          <div class="mb-6">
            <h3 class="text-sm font-medium text-gray-700 mb-3">
              Filtro por fecha de despacho:
            </h3>
            <div class="flex flex-wrap items-center gap-3 mb-3">
              <button
                id="incf-btn-selected"
                type="button"
                class="px-4 py-2 rounded-xl font-semibold bg-indigo-600 text-white border border-indigo-600"
                onclick="setIncExecutiveFilter('selected')"
              >
                Fecha seleccionada
              </button>

              <button
                id="incf-btn-today"
                type="button"
                class="px-4 py-2 rounded-xl font-semibold bg-white text-gray-700 border"
                onclick="setIncExecutiveFilter('today')"
              >
                Hoy
              </button>

              <button
                id="incf-btn-7"
                type="button"
                class="px-4 py-2 rounded-xl font-semibold bg-white text-gray-700 border"
                onclick="setIncExecutiveFilter('last7')"
              >
                Últimos 7 dias
              </button>

              <button
                id="incf-btn-30"
                type="button"
                class="px-4 py-2 rounded-xl font-semibold bg-white text-gray-700 border"
                onclick="setIncExecutiveFilter('last30')"
              >
                Últimos 30 dias
              </button>

              <button
                id="incf-btn-all"
                type="button"
                class="px-4 py-2 rounded-xl font-semibold bg-white text-gray-700 border"
                onclick="setIncExecutiveFilter('all')"
              >
                Todo
              </button>

              <div class="flex items-center gap-2 flex-wrap ml-auto">
                <span class="text-sm text-gray-600">Rango:</span>

                <input
                  id="incf-from"
                  type="date"
                  class="p-2 border rounded-lg"
                />
                <input id="incf-to" type="date" class="p-2 border rounded-lg" />

                <button
                  type="button"
                  class="bg-gray-900 text-white px-4 py-2 rounded-xl font-semibold hover:bg-gray-800"
                  onclick="applyIncExecutiveRange()"
                >
                  Aplicar
                </button>
              </div>
            </div>
          </div>

          <div id="informe-container" class="overflow-x-auto">
            <p class="text-gray-600">
              Seleccione una fecha (arriba) para generar el informe.
            </p>
          </div>

          <!-- REPORTE DE INCIDENCIAS -->
          <div class="mb-8">
            <div class="border rounded-xl overflow-hidden">
              <div
                class="flex items-center justify-between px-4 py-3 bg-gray-50 border-b"
              >
                <h3 class="font-semibold text-gray-800">
                  Incidencias (columna S)
                </h3>
                <p class="text-xs text-gray-500">
                  Se muestran como: Unidad · Tipo de incidencia · Fecha de
                  ocurrencia
                </p>
              </div>

              <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                  <thead class="bg-white">
                    <tr class="text-gray-700 border-b">
                      <th class="px-4 py-3 text-left font-semibold">Unidad</th>
                      <th class="px-4 py-3 text-left font-semibold">
                        Tipo de incidencia
                      </th>
                      <th class="px-4 py-3 text-left font-semibold">Fecha</th>
                      <th class="px-4 py-3 text-left font-semibold">
                        Dirección
                      </th>
                    </tr>
                  </thead>
                  <tbody
                    id="incidencias-exec-tbody"
                    class="divide-y bg-white"
                  ></tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="mt-8 text-right border-t pt-6 space-x-3">
            <button
              id="download-excel-report-btn"
              onclick="downloadReportAsExcel()"
              disabled
              class="bg-blue-600 text-white px-6 py-2 rounded-lg disabled:bg-gray-400 hover:bg-blue-700"
            >
              Descargar Detalle (XLSX)
            </button>
            <button
              id="guardar-informe-btn"
              onclick="guardarInformeEnBD()"
              class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700"
            >
              Guardar Informe
            </button>
          </div>
        </div>

        <!-- TAB 6 -->
        <div id="tab-6" class="tab-content-item hidden">
          <h2 class="text-2xl font-semibold mb-4 text-gray-800">
            Informes Guardados
          </h2>

          <div class="mb-6">
            <button
              onclick="cargarInformesGuardados()"
              class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
            >
              Actualizar Lista
            </button>
          </div>

          <!-- Filtros -->
          <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
            <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
              <div class="md:col-span-2">
                <label
                  for="informes-filtro-texto"
                  class="block text-sm font-medium text-gray-700"
                  >Buscar</label
                >
                <input
                  id="informes-filtro-texto"
                  type="text"
                  placeholder="Título, ID, unidad, fecha de despacho..."
                  oninput="applyInformesFilters()"
                  class="mt-1 w-full p-2 border rounded-lg"
                />
              </div>
              <div>
                <label
                  for="informes-filtro-fecha-desde"
                  class="block text-sm font-medium text-gray-700"
                  >Despacho desde</label
                >
                <input
                  id="informes-filtro-fecha-desde"
                  type="date"
                  onchange="applyInformesFilters()"
                  class="mt-1 w-full p-2 border rounded-lg"
                />
              </div>
              <div>
                <label
                  for="informes-filtro-fecha-hasta"
                  class="block text-sm font-medium text-gray-700"
                  >Despacho hasta</label
                >
                <input
                  id="informes-filtro-fecha-hasta"
                  type="date"
                  onchange="applyInformesFilters()"
                  class="mt-1 w-full p-2 border rounded-lg"
                />
              </div>
              <div>
                <label
                  for="informes-filtro-unidad"
                  class="block text-sm font-medium text-gray-700"
                  >Unidad</label
                >
                <select
                  id="informes-filtro-unidad"
                  onchange="applyInformesFilters()"
                  class="mt-1 w-full p-2 border rounded-lg"
                >
                  <option value="">Todas</option>
                </select>
              </div>
            </div>

            <div class="flex flex-wrap items-center justify-between mt-3 gap-3">
              <label
                class="inline-flex items-center gap-2 text-sm text-gray-700"
              >
                <input
                  id="informes-filtro-solo-incidencias"
                  type="checkbox"
                  onchange="applyInformesFilters()"
                  class="h-4 w-4"
                />
                Solo con incidencias
              </label>

              <div class="flex items-center gap-3">
                <p
                  id="informes-filtro-resumen"
                  class="text-sm text-gray-500"
                ></p>
                <button
                  type="button"
                  onclick="resetInformesFilters()"
                  class="bg-gray-200 text-gray-700 px-3 py-2 rounded-lg hover:bg-gray-300"
                >
                  Limpiar filtros
                </button>
              </div>
            </div>
          </div>

          <div id="informes-lista-container" class="overflow-x-auto">
            <div class="text-center p-6">
              <p class="text-gray-500">Cargando informes guardados...</p>
              <div
                class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500 mt-2"
              ></div>
            </div>
          </div>

          <!-- Modal: Ver informe -->
          <div
            id="modal-informe-detalle"
            class="modal hidden fixed inset-0 flex items-center justify-center z-50 p-4"
          >
            <div
              class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden"
            >
              <div class="flex justify-between items-center mb-4 p-6 border-b">
                <h3
                  class="text-xl font-bold text-gray-800"
                  id="modal-informe-titulo"
                ></h3>
                <div class="space-x-2">
                  <button
                    onclick="closeModal('modal-informe-detalle')"
                    class="text-gray-400 hover:text-gray-600"
                    title="Cerrar"
                  >
                    <svg
                      class="w-6 h-6"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M6 18L18 6M6 6l12 12"
                      />
                    </svg>
                  </button>
                </div>
              </div>
              <div
                id="modal-informe-body"
                class="p-6 overflow-y-auto max-h-[60vh]"
              ></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: Login -->
    <div
      id="login-modal"
      class="hidden modal fixed inset-0 flex items-center justify-center z-50 p-4"
    >
      <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-8">
        <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">
          Acceso a Bitácora
        </h3>
        <form id="login-form" onsubmit="handleLogin(event)" class="space-y-4">
          <div>
            <label
              for="username"
              class="block text-sm font-medium text-gray-700"
              >Usuario</label
            >
            <input
              type="text"
              id="username"
              name="username"
              required
              class="mt-1 w-full p-2 border border-gray-300 rounded-md"
            />
          </div>
          <div>
            <label
              for="password"
              class="block text-sm font-medium text-gray-700"
              >Contraseña</label
            >
            <input
              type="password"
              id="password"
              name="password"
              required
              class="mt-1 w-full p-2 border border-gray-300 rounded-md"
            />
          </div>
          <div
            id="login-error-message"
            class="text-sm text-red-600 hidden"
          ></div>
          <button
            type="submit"
            class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 font-semibold"
          >
            Iniciar Sesión
          </button>
        </form>
        <p class="text-center text-xs text-gray-500 mt-4">
          Editor: user/editor · Lector: view/read
        </p>
      </div>
    </div>

    <!-- Modal: Datos unidad -->
    <div
      id="data-modal"
      class="modal hidden fixed inset-0 flex items-center justify-center z-50 p-4"
    >
      <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-gray-800">Datos de Unidad</h3>
          <button
            onclick="closeModal('data-modal')"
            class="text-gray-400 hover:text-gray-600"
          >
            ✕
          </button>
        </div>
        <div id="modal-body" class="text-gray-600"></div>
      </div>
    </div>

    <!-- Modal: 911 -->
    <div
      id="emergency911-modal"
      class="modal hidden fixed inset-0 flex items-center justify-center z-50 p-4"
    >
      <div
        class="bg-white rounded-xl shadow-2xl w-full max-w-5xl overflow-hidden"
      >
        <div class="flex justify-between items-center p-6 border-b">
          <h3 class="text-xl font-bold text-gray-800">
            Números de Emergencia 911
          </h3>
          <button
            onclick="closeModal('emergency911-modal')"
            class="text-gray-400 hover:text-gray-600"
          >
            ✕
          </button>
        </div>

        <div class="p-6">
          <div class="flex flex-col md:flex-row gap-3 md:items-center mb-4">
            <select
              id="em911-estado"
              class="p-2 border rounded-lg w-full md:w-64"
              onchange="applyEmergency911Filters()"
            >
              <option value="all">Todos los estados</option>
            </select>
            <input
              id="em911-search"
              type="text"
              placeholder="Buscar municipio..."
              class="p-2 border rounded-lg w-full"
              oninput="applyEmergency911Filters()"
            />
            <!-- <button
              type="button"
              onclick="loadMoreEmergency911Rows()"
              class="bg-gray-800 text-white px-4 py-2 rounded-lg hover:bg-gray-900"
            >
              Cargar más
            </button> -->
          </div>
          <div id="em911-status" class="text-sm text-gray-500 mb-3"></div>
          <div class="overflow-auto border rounded-lg" style="max-height: 60vh">
            <table class="min-w-full text-sm">
              <thead class="bg-gray-50 sticky top-0">
                <tr>
                  <th class="px-4 py-2 text-left font-semibold text-gray-700">
                    Estado
                  </th>
                  <th class="px-4 py-2 text-left font-semibold text-gray-700">
                    Municipio
                  </th>
                  <th class="px-4 py-2 text-left font-semibold text-gray-700">
                    Teléfono
                  </th>
                </tr>
              </thead>
              <tbody id="em911-tbody" class="divide-y bg-white"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: Contactos -->
    <div
      id="emergency-contacts-modal"
      class="modal hidden fixed inset-0 flex items-center justify-center z-50 p-4"
    >
      <div
        class="bg-white rounded-xl shadow-2xl w-full max-w-4xl overflow-hidden"
      >
        <div class="flex justify-between items-center p-6 border-b">
          <h3 class="text-xl font-bold text-gray-800">
            Contactos de Emergencia
          </h3>
          <button
            onclick="closeModal('emergency-contacts-modal')"
            class="text-gray-400 hover:text-gray-600"
          >
            ✕
          </button>
        </div>
        <div class="p-6">
          <div
            id="emergency-contacts-body"
            class="grid grid-cols-1 md:grid-cols-2 gap-4"
          ></div>
          <p class="text-xs text-gray-500 mt-4">
            *Directorio informativo (no realiza llamadas automáticas).
          </p>
        </div>
      </div>
    </div>

    <!-- Modal: Confirmar Guardar Sin Incidencias -->
    <div
      id="confirm-save-modal"
      class="modal hidden fixed inset-0 flex items-center justify-center z-50 p-4"
    >
      <div
        class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden"
      >
        <div class="flex justify-between items-center p-5 border-b bg-amber-50">
          <div class="flex items-center gap-3">
            <div
              class="w-10 h-10 bg-amber-100 rounded-full flex items-center justify-center"
            >
              <svg
                class="w-6 h-6 text-amber-600"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
                ></path>
              </svg>
            </div>
            <h3 class="text-lg font-bold text-gray-800">Confirmar acción</h3>
          </div>
          <button
            onclick="closeConfirmSaveModal(false)"
            class="text-gray-400 hover:text-gray-600 text-xl"
          >
            ✕
          </button>
        </div>
        <div class="p-6">
          <p class="text-gray-600 mb-6">
            No hay incidencias registradas para este seguimiento.<br />
            <span class="font-medium text-gray-800">¿Desea guardar?</span>
          </p>
          <div class="flex gap-3 justify-end">
            <button
              onclick="closeConfirmSaveModal(false)"
              class="px-5 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition font-medium"
            >
              Cancelar
            </button>
            <button
              onclick="closeConfirmSaveModal(true)"
              class="px-5 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-medium"
            >
              Sí, guardar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: Protocolo -->
    <div
      id="protocolo-modal"
      class="modal hidden fixed inset-0 flex items-center justify-center z-50 p-4"
    >
      <div
        class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden"
      >
        <div class="flex justify-between items-center p-6 border-b">
          <h3
            id="protocolo-modal-title"
            class="text-xl font-bold text-gray-800"
          >
            Protocolo
          </h3>
          <button
            onclick="closeModal('protocolo-modal')"
            class="text-gray-400 hover:text-gray-600"
          >
            ✕
          </button>
        </div>
        <div id="protocolo-modal-body" class="p-6"></div>
      </div>
    </div>

    <script>
      const USER_ROLES = {
        editor: {
          username: "user",
          password: "editor",
          tabs: [0, 1, 2, 3, 4, 5, 6],
        },
        lector: { username: "view", password: "read", tabs: [3, 4, 5, 6] },
      };

      let userRole = null;
      function setUserRole(role) {
        userRole = role;
        try {
          sessionStorage.setItem("bitacoraUserRole", role);
        } catch (e) {}
        const loginModal = document.getElementById("login-modal");
        if (loginModal) loginModal.classList.add("hidden");
        updateTabVisibility();
      }

      Chart.register(ChartDataLabels);

      let allDespachosData = [];
      let filteredDespachosData = [];
      let charts = {};
      let lastInformeData = [];

      /* ===========================
   HELPERS
=========================== */

      function updateClienteDisplay() {
        const nameEl = document.getElementById("cliente-display-name");
        if (!nameEl) return;

        const clientes = [
          ...new Set(
            (filteredDespachosData || [])
              .map((d) => String(d?.cliente || "").trim())
              .filter(Boolean),
          ),
        ];

        if (!clientes.length) {
          nameEl.textContent = "-";
          return;
        }

        if (clientes.length === 1) {
          nameEl.textContent = clientes[0];
          return;
        }

        nameEl.textContent = `${clientes.join(", ")}`;
      }

      async function enviarIncidencia(datosIncidencia) {
        const urlWebhook =
          "https://hook.us2.make.com/yndsuutplxn2j0n18o6l4u5qykhjrflj";
        try {
          const response = await fetch(urlWebhook, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              titulo: datosIncidencia.titulo,
              descripcion: datosIncidencia.cuerpo,
              fecha: new Date().toISOString(),
              direccion: datosIncidencia.direccion || "",
            }),
          });
          if (response.ok) console.log("Incidencia enviada con éxito");
          else console.warn("Make respondió con error HTTP:", response.status);
        } catch (error) {
          console.error("Error al conectar con Make:", error);
        }
      }

      function escapeHtml(v) {
        return String(v ?? "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function handleIncidenciaTipoChange() {
        const sel = document.getElementById("incidencia-tipo");

        const wrap = document.getElementById("incidencia-direccion-wrapper");

        const input = document.getElementById("incidencia-direccion");

        if (!sel || !wrap || !input) return;

        const hasValue = String(sel.value || "").trim().length > 0;

        wrap.classList.toggle("hidden", !hasValue);

        if (!hasValue) {
          input.value = "";
        } else {
          // foco para captura rápida

          input.focus();
        }
      }

      function excelDateToYYYYMMDD(value) {
        if (value === null || value === undefined) return "";
        if (value instanceof Date && !isNaN(value))
          return dayjs(value).format("YYYY-MM-DD");

        let s = String(value).trim();
        if (!s) return "";

        // Si tiene hora, extraer solo la parte de fecha
        s = s.split(/\s+/)[0];
        s = s.replace(/\/+/g, "/").replace(/-+/g, "-");

        const parsed = dayjs(
          s,
          [
            "YYYY-MM-DD",
            "YYYY/MM/DD",
            "DD-MM-YYYY",
            "DD/MM/YYYY",
            "D-M-YYYY",
            "D/M/YYYY",
          ],
          true,
        );
        return parsed.isValid() ? parsed.format("YYYY-MM-DD") : "";
      }

      function parseExcelDateTime(timeValue, dateValue) {
        if (!timeValue) return "";

        const fullFormats = [
          "DD-MM-YYYY HH:mm:ss",
          "DD/MM/YYYY HH:mm:ss",
          "DD-MM-YYYY H:mm:ss",
          "DD/MM/YYYY H:mm:ss",
          "DD-MM-YYYY HH:mm",
          "DD/MM/YYYY HH:mm",
          "DD-MM-YYYY H:mm",
          "DD/MM/YYYY H:mm",
          "YYYY-MM-DD HH:mm:ss",
          "YYYY-MM-DD H:mm:ss",
          "YYYY/MM/DD HH:mm:ss",
          "YYYY/MM/DD H:mm:ss",
        ];

        let dt = dayjs(String(timeValue), fullFormats, true);

        if (!dt.isValid()) {
          const str = String(timeValue).trim();

          const dateTimeMatch = str.match(
            /^(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{4})\s+(\d{1,2}:\d{2}(?::\d{2})?)$/,
          );
          if (dateTimeMatch) {
            const datePart = dateTimeMatch[1];
            const timePart = dateTimeMatch[2];
            const baseParsed = dayjs(
              datePart,
              ["DD-MM-YYYY", "DD/MM/YYYY", "MM-DD-YYYY", "MM/DD/YYYY"],
              true,
            );
            const timeMatch = timePart.match(/(\d{1,2}):(\d{2})(?::(\d{2}))?/);

            if (baseParsed.isValid() && timeMatch) {
              dt = baseParsed
                .hour(parseInt(timeMatch[1], 10))
                .minute(parseInt(timeMatch[2], 10))
                .second(timeMatch[3] ? parseInt(timeMatch[3], 10) : 0);
            }
          }
        }

        if (!dt.isValid() && dateValue) {
          const base = dayjs(
            String(dateValue),
            ["DD-MM-YYYY", "DD/MM/YYYY", "YYYY-MM-DD"],
            true,
          );
          const m = String(timeValue).match(/(\d{1,2}):(\d{2})(?::(\d{2}))?/);
          if (base.isValid() && m) {
            dt = base
              .hour(parseInt(m[1], 10))
              .minute(parseInt(m[2], 10))
              .second(m[3] ? parseInt(m[3], 10) : 0);
          }
        }

        return dt.isValid() ? dt.toISOString() : "";
      }

      function formatDateTime(iso) {
        if (!iso || !dayjs(iso).isValid()) return "-";
        const d = dayjs(iso);
        const date = d.format("DD/MM/YYYY");
        const hour = d.hour();
        const minute = d.format("mm");
        const second = d.format("ss");
        const hour12 = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
        const ampm = hour < 12 ? "a.m." : "p.m.";
        return `${date} ${String(hour12).padStart(2, "0")}:${minute}:${second} ${ampm}`;
      }
      function formatForInput(iso) {
        if (!iso) return "";
        const d = dayjs(iso);
        return d.isValid() ? d.format("YYYY-MM-DDTHH:mm:ss") : "";
      }

      function checkTimeDeviation(prog, real) {
        if (!prog || !real) return "task-cell";
        const p = dayjs(prog),
          r = dayjs(real);
        if (!p.isValid() || !r.isValid()) return "task-cell";
        const diff = r.diff(p, "minute");
        return diff > 10 ? "estatus-rojo" : "estatus-verde";
      }

      /* ===========================
   LOGIN + TABS
=========================== */
      function handleLogin(event) {
        if (event && event.preventDefault) event.preventDefault();
        const username = (
          document.getElementById("username")?.value || ""
        ).trim();
        const password = (
          document.getElementById("password")?.value || ""
        ).trim();
        const errorMessage = document.getElementById("login-error-message");
        if (errorMessage) errorMessage.classList.add("hidden");

        const CREDENTIALS = [
          { u: "user", p: "editor", role: "editor" },
          { u: "view", p: "read", role: "lector" },
        ];
        const match = CREDENTIALS.find(
          (c) => c.u === username && c.p === password,
        );
        if (!match) {
          if (errorMessage) {
            errorMessage.textContent = "Usuario o contraseña incorrectos.";
            errorMessage.classList.remove("hidden");
          }
          return false;
        }
        setUserRole(match.role);
        return false;
      }

      function updateTabVisibility() {
        const allowed = USER_ROLES[userRole]?.tabs ?? [];
        for (let i = 0; i < 7; i++) {
          const btn = document.getElementById(`tab-btn-${i}`);
          const tab = document.getElementById(`tab-${i}`);
          if (btn) btn.classList.toggle("hidden", !allowed.includes(i));
          if (tab && !allowed.includes(i)) tab.classList.add("hidden");
        }
        changeTab(allowed[0] ?? 0);
      }

      function changeTab(index) {
        if (!userRole) {
          document.getElementById("login-modal").classList.remove("hidden");
          return;
        }
        const allowed = USER_ROLES[userRole].tabs;
        if (!allowed.includes(index)) {
          alert("No tienes permiso para acceder a esta pestaña.");
          return;
        }
        for (let i = 0; i < 7; i++) {
          const btn = document.getElementById(`tab-btn-${i}`);
          const tab = document.getElementById(`tab-${i}`);
          if (btn && !btn.classList.contains("hidden")) {
            btn.classList.toggle("tab-active", i === index);
            btn.classList.toggle("text-gray-500", i !== index);
          }
          if (tab) tab.classList.toggle("hidden", i !== index);
        }
        if (index === 4) renderKPIs(filteredDespachosData);
        if (index === 5) {
          renderInforme(allDespachosData);
          renderIncidenciasExecutiveReport();
        }
        if (index === 6) cargarInformesGuardados();
      }

      /* ===========================
   MODALS
=========================== */
      function openModal(id) {
        document.getElementById(id).classList.remove("hidden");
      }
      function closeModal(id) {
        document.getElementById(id).classList.add("hidden");
      }
      window.onclick = (ev) => {
        if (ev.target.classList.contains("modal"))
          ev.target.classList.add("hidden");
      };

      /* ===========================
   DATA LOAD (Sheets)
=========================== */
      async function loadDataFromGoogleSheets(isInitialLoad = true) {
        const url =
          "/bitacora_/src/api/google-sheets-proxy.php?action=bitacora";
        const response = await fetch(url);
        const apiResponse = await response.json();
        const values = apiResponse.data || [];
        const jsonData = convertSheetDataToObjects(values);
        processData(jsonData);
      }

      async function loadEmergencyContactsFromSheet() {
        const url =
          "/bitacora_/src/api/google-sheets-proxy.php?action=contactos";

        try {
          const response = await fetch(url);
          const apiResponse = await response.json();
          const data = { values: apiResponse.data || [] };

          if (!data.values || data.values.length < 2) {
            return [];
          }

          const rows = data.values;
          const headers = rows[0].map((h) =>
            (h || "")
              .toString()
              .trim()
              .toLowerCase()
              .replace(/[^a-záéíóúñü\s]/g, ""),
          );

          // Mapear tus encabezados exactos:
          const headerMap = {
            "nombre contacto": "label",
            nombre: "label",
            "cargo/posicion": "cargo",
            cargo: "cargo",
            "area/departamento": "departamento",
            departamento: "departamento",
            "prioridad contacto": "prioridad",
            prioridad: "prioridad",
            telefonos: "telefonos",
            correos: "correos",
            accionesatomar: "acciones",
            acciones: "acciones",
            observaciones: "observaciones",
          };

          const records = rows.slice(1).map((row) => {
            const obj = {};

            headers.forEach((header, i) => {
              const normalizedHeader =
                Object.keys(headerMap).find(
                  (key) => header.includes(key) || key.includes(header),
                ) || header;

              obj[headerMap[normalizedHeader] || normalizedHeader] =
                row[i] || "";
            });

            return {
              label: obj.label || "Contacto",
              nombre: obj.nombre || obj.label || "",
              cargo: obj.cargo || "",
              departamento: obj.departamento || "",
              prioridad: obj.prioridad || "Normal",
              telefonos: (obj.telefonos || "")
                .split(/[\n,;|]/) // Soporta comas, punto-coma, saltos de línea
                .map((t) => t.trim())
                .filter(Boolean),
              correos: (obj.correos || "")
                .split(/[\n,;|]/)
                .map((c) => c.trim())
                .filter(Boolean),
              acciones: obj.acciones || "",
              observaciones: obj.observaciones || "",
            };
          });

          // Filtrar filas vacías
          return records.filter((r) => r.nombre && r.nombre.trim());
        } catch (error) {
          console.error("Error cargando contactos de emergencia:", error);
          return [];
        }
      }

      function convertSheetDataToObjects(data) {
        if (data.length < 2) return [];
        const headers = data
          .shift()
          .map((h) => (typeof h === "string" ? h.trim().toLowerCase() : h));
        return data
          .map((row) => {
            const obj = {};
            headers.forEach((header, index) => {
              if (header) obj[header] = row[index] || "";
            });
            return obj;
          })
          .filter((row) => row.unidad && String(row.unidad).trim() !== "");
      }

      function readSavedMap() {
        try {
          const raw = localStorage.getItem("bitacoraData");
          const arr = raw ? JSON.parse(raw) : null;
          if (!Array.isArray(arr)) return new Map();
          const m = new Map();
          arr.forEach((d) =>
            m.set(`${d.folio}-${d.unidad}-${d.fechaProgramada}`, d),
          );
          return m;
        } catch (e) {
          return new Map();
        }
      }

      function processData(sheetRows) {
        const savedMap = readSavedMap();

        allDespachosData = sheetRows.map((row, idx) => {
          const fechaProg = excelDateToYYYYMMDD(row["fecha"]);
          const base = {
            folio: row["folio"] || idx + 1,
            fechaProgramada: fechaProg,
            unidad: row["unidad"] || "N/A",
            placas: row["placas"] || "N/A",
            operador: row["operador"] || "N/A",
            telefono: row["teléfono"] || row["telefono"] || "N/A",
            ruta: row["ruta"] || "N/A",
            origen: row["origen"] || "N/A",
            destino: row["destino"] || "N/A",
            citaSalidaUnidad: parseExcelDateTime(
              row["salida_prog"],
              row["fecha"],
            ),
            citaCarga: parseExcelDateTime(row["carga_prog"], row["fecha"]),
            citaSalida: parseExcelDateTime(
              row["salida_carga_prog"],
              row["fecha"],
            ),
            citaDescarga: parseExcelDateTime(
              row["descarga_prog"],
              row["fecha"],
            ),
            cliente: row["cliente"] || "N/A",
            realSalidaUnidad: "",
            realCarga: "",
            realSalida: "",
            realDescarga: "",
            confirmacionEntrega: null,
            estatus: "Programado",
            incidencias: [],
            observaciones: "",
            operadorMonitoreoId: row["operador_monitoreo"] || "",
            gpsValidacionEstado: row["gps_validacion_estado"] || "",
            gpsValidacionTimestamp: row["gps_validacion_timestamp"] || "",
          };

          const key = `${base.folio}-${base.unidad}-${base.fechaProgramada}`;
          if (savedMap.has(key)) {
            const saved = savedMap.get(key);
            const merged = { ...base, ...saved };
            // Mantener siempre los datos de Google Sheets (no localStorage)
            merged.folio = base.folio;
            merged.unidad = base.unidad;
            merged.fechaProgramada = base.fechaProgramada;
            merged.cliente = base.cliente; // ✅ Siempre usar cliente de Google Sheets
            merged.placas = base.placas;
            merged.operador = base.operador;
            merged.telefono = base.telefono;
            merged.ruta = base.ruta;
            merged.origen = base.origen;
            merged.destino = base.destino;
            merged.citaSalidaUnidad = base.citaSalidaUnidad;
            merged.citaCarga = base.citaCarga;
            merged.citaSalida = base.citaSalida;
            merged.citaDescarga = base.citaDescarga;
            return merged;
          }
          return base;
        });

        saveAllData();

        const dateInput = document.getElementById("date-filter");
        if (!dateInput.value) {
          const dates = [
            ...new Set(
              allDespachosData.map((d) => d.fechaProgramada).filter(Boolean),
            ),
          ].sort((a, b) => dayjs(b).diff(dayjs(a)));
          dateInput.value = dates[0] || dayjs().format("YYYY-MM-DD");
        }
        filterByDate();

        // Cargar/mezclar seguimiento desde BD (no bloquea la UI)
        try {
          loadSeguimientosFromDb()
            .then(() => {
              renderAllTabs();
            })
            .catch((e) => {
              console.warn("Error cargando seguimientos desde BD:", e);
            });
        } catch (e) {
          console.warn("Error iniciando carga de seguimientos:", e);
        }
      }

      function saveAllData() {
        try {
          localStorage.setItem(
            "bitacoraData",
            JSON.stringify(allDespachosData),
          );
        } catch (e) {}
      }

      function filterByDate() {
        const selectedDate = document.getElementById("date-filter").value;
        if (!selectedDate) filteredDespachosData = [...allDespachosData];
        else
          filteredDespachosData = allDespachosData.filter(
            (d) => d.fechaProgramada === selectedDate,
          );
        // Si ya cargamos seguimientos desde BD, aplicarlos a la vista actual.
        try {
          applySeguimientosDbToArray(filteredDespachosData);
        } catch (e) {
          console.warn("Error aplicando seguimientos desde BD:", e);
        }
        renderAllTabs();
      }

      function renderAllTabs() {
        renderDatosGenerales();
        renderOrigenDestino();
        populateUnidadSelector();
        populateRegistroFilter();
        renderRegistroDespacho();
        renderKPIs(filteredDespachosData);
        renderInforme(filteredDespachosData);
        renderIncidenciasExecutiveReport();
        updateClienteDisplay();
      }

      /* ===========================
   TAB 0 / TAB 1
=========================== */
      function renderDatosGenerales() {
        const c = document.getElementById("datos-generales-container");
        c.innerHTML = "";

        // Actualizar selectores de filtros
        actualizarFiltrosDatosGenerales();

        if (filteredDespachosData.length === 0) {
          c.innerHTML = `<div class="col-span-full text-center p-10 bg-white rounded-xl shadow"><h3 class="text-lg">No hay despachos para esta fecha</h3></div>`;
          actualizarContadorDatosGenerales(0, 0);
          return;
        }

        // Obtener valores de filtros
        const filtroUnidad =
          document.getElementById("filtro-unidad-dg")?.value || "";
        const filtroMaxTramos = parseInt(
          document.getElementById("filtro-max-tramos")?.value || "0",
          10,
        );
        const filtroCliente =
          document.getElementById("filtro-cliente-dg")?.value || "";

        // Filtrar datos según selección
        let datosFiltrados = filteredDespachosData;

        // Filtrar por unidad específica
        if (filtroUnidad) {
          datosFiltrados = datosFiltrados.filter(
            (d) => String(d.unidad || "").trim() === filtroUnidad,
          );
        }

        // Filtrar por cliente
        if (filtroCliente) {
          datosFiltrados = datosFiltrados.filter(
            (d) => String(d.cliente || "").trim() === filtroCliente,
          );
        }

        // Contar registros por unidad para agregar tramos
        const unidadCount = {};
        const unidadIndex = {};
        datosFiltrados.forEach((d) => {
          const unidadNombre = String(d.unidad || "").trim();
          unidadCount[unidadNombre] = (unidadCount[unidadNombre] || 0) + 1;
          unidadIndex[unidadNombre] = 0;
        });

        let mostrados = 0;
        datosFiltrados.forEach((d) => {
          // Determinar número de tramo si hay múltiples registros
          const unidadNombre = String(d.unidad || "").trim();
          const tieneMultiplesTramos = unidadCount[unidadNombre] > 1;
          unidadIndex[unidadNombre] = (unidadIndex[unidadNombre] || 0) + 1;
          const numeroTramo = unidadIndex[unidadNombre];

          // Aplicar límite de tramos (0 = sin límite)
          if (filtroMaxTramos > 0 && numeroTramo > filtroMaxTramos) {
            return; // Saltar este tramo
          }

          mostrados++;
          const tramoLabel = tieneMultiplesTramos
            ? ` - Tramo ${numeroTramo}${filtroMaxTramos > 0 && unidadCount[unidadNombre] > filtroMaxTramos ? ` de ${unidadCount[unidadNombre]}` : ""}`
            : "";

          c.innerHTML += `
            <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-100">
              <div class="flex justify-between items-start mb-3">
                <div>
                  <h3 class="font-bold text-lg text-blue-800">${escapeHtml(
                    d.unidad,
                  )}${tramoLabel}</h3>
                  <p class="text-sm text-gray-500">${escapeHtml(d.placas)}</p>
                </div>
                <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">
                  Folio: ${String(d.folio).padStart(3, "0")}
                </span>
              </div>
              <div class="space-y-2 text-sm">
                <p><strong>Operador:</strong> ${escapeHtml(d.operador)}</p>
                <p><strong>Ruta:</strong> ${escapeHtml(d.ruta)}</p>
                <p><strong>Destino:</strong> ${escapeHtml(d.destino)}</p>
                <p><strong>Cliente:</strong> ${escapeHtml(d.cliente)}</p>
              </div>
            </div>`;
        });

        actualizarContadorDatosGenerales(mostrados, datosFiltrados.length);

        if (mostrados === 0) {
          c.innerHTML = `<div class="col-span-full text-center p-10 bg-white rounded-xl shadow"><h3 class="text-lg">No hay despachos que coincidan con los filtros</h3></div>`;
        }
      }

      function actualizarFiltrosDatosGenerales() {
        const selectUnidad = document.getElementById("filtro-unidad-dg");
        const selectCliente = document.getElementById("filtro-cliente-dg");

        if (!selectUnidad || !selectCliente) return;

        // Guardar valores actuales
        const unidadActual = selectUnidad.value;
        const clienteActual = selectCliente.value;

        // Obtener unidades únicas
        const unidades = [
          ...new Set(
            filteredDespachosData
              .map((d) => String(d.unidad || "").trim())
              .filter((u) => u),
          ),
        ].sort();

        // Obtener clientes únicos
        const clientes = [
          ...new Set(
            filteredDespachosData
              .map((d) => String(d.cliente || "").trim())
              .filter((c) => c),
          ),
        ].sort();

        // Actualizar select de unidades
        selectUnidad.innerHTML = '<option value="">Todas las unidades</option>';
        unidades.forEach((u) => {
          const selected = u === unidadActual ? "selected" : "";
          selectUnidad.innerHTML += `<option value="${escapeHtml(u)}" ${selected}>${escapeHtml(u)}</option>`;
        });

        // Actualizar select de clientes
        selectCliente.innerHTML =
          '<option value="">Todos los clientes</option>';
        clientes.forEach((c) => {
          const selected = c === clienteActual ? "selected" : "";
          selectCliente.innerHTML += `<option value="${escapeHtml(c)}" ${selected}>${escapeHtml(c)}</option>`;
        });
      }

      function actualizarContadorDatosGenerales(mostrados, total) {
        const contador = document.getElementById("contador-datos-generales");
        if (contador) {
          if (mostrados === total) {
            contador.textContent = `Mostrando ${mostrados} despachos`;
          } else {
            contador.textContent = `Mostrando ${mostrados} de ${total} despachos`;
          }
        }
      }

      function limpiarFiltrosDatosGenerales() {
        const selectUnidad = document.getElementById("filtro-unidad-dg");
        const selectMaxTramos = document.getElementById("filtro-max-tramos");
        const selectCliente = document.getElementById("filtro-cliente-dg");

        if (selectUnidad) selectUnidad.value = "";
        if (selectMaxTramos) selectMaxTramos.value = "3"; // Valor por defecto
        if (selectCliente) selectCliente.value = "";

        renderDatosGenerales();
      }

      function renderOrigenDestino() {
        const c = document.getElementById("origen-destino-container");
        c.innerHTML = "";
        if (filteredDespachosData.length === 0) {
          c.innerHTML = `<div class="col-span-full text-center p-10 bg-white rounded-xl shadow"><h3 class="text-lg">Sin datos de rutas</h3></div>`;
          return;
        }

        // Contar registros por unidad para agregar tramos
        const unidadCount = {};
        const unidadIndex = {};
        filteredDespachosData.forEach((d) => {
          const unidadNombre = String(d.unidad || "").trim();
          unidadCount[unidadNombre] = (unidadCount[unidadNombre] || 0) + 1;
          unidadIndex[unidadNombre] = 0;
        });

        filteredDespachosData.forEach((d) => {
          // Determinar número de tramo si hay múltiples registros
          const unidadNombre = String(d.unidad || "").trim();
          const tieneMultiplesTramos = unidadCount[unidadNombre] > 1;
          unidadIndex[unidadNombre] = (unidadIndex[unidadNombre] || 0) + 1;
          const numeroTramo = unidadIndex[unidadNombre];
          const tramoLabel = tieneMultiplesTramos
            ? ` - Tramo ${numeroTramo}`
            : "";

          const origenUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(
            d.origen || "",
          )}`;
          const destinoUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(
            d.destino || "",
          )}`;
          c.innerHTML += `
            <div class="bg-white p-5 rounded-xl shadow border">
              <h3 class="font-bold text-lg text-blue-800">${escapeHtml(
                d.unidad,
              )}${tramoLabel}</h3>
              <p class="text-sm text-gray-500">${escapeHtml(d.ruta)}</p>
              <p class="text-sm mt-2"><strong>Origen:</strong>
                <a href="${origenUrl}" target="_blank" class="text-blue-600 underline">${escapeHtml(
                  d.origen || "N/A",
                )}</a>
              </p>
              <p class="text-sm"><strong>Destino:</strong>
                <a href="${destinoUrl}" target="_blank" class="text-blue-600 underline">${escapeHtml(
                  d.destino || "N/A",
                )}</a>
              </p>
              <p class="text-sm"><strong>Cliente:</strong> ${escapeHtml(
                d.cliente || "N/A",
              )}</p>
            </div>`;
        });
      }

      /* ===========================
   TAB 2 (seguimiento) - versión compacta
=========================== */

      function renderClienteFilter() {
        const container = document.getElementById("cliente-filter-container");
        if (!container) return;

        // Obtener clientes únicos
        const clientes = [
          ...new Set(
            filteredDespachosData
              .map((d) => d.cliente)
              .filter((c) => c && c.trim()),
          ),
        ].sort();

        let html = `
        <div class="mb-4">
          <label class="block mb-2 font-semibold">Filtrar por Cliente:</label>
          <select id="cliente-filter" onchange="filterByCliente()" 
                  class="border px-3 py-2 rounded w-full max-w-md">
            <option value="">Todos los clientes</option>
      `;

        clientes.forEach((cliente) => {
          html += `<option value="${escapeHtml(cliente)}">${escapeHtml(
            cliente,
          )}</option>`;
        });

        html += `</select></div>`;
        container.innerHTML = html;
      }

      function filterByCliente() {
        const select = document.getElementById("cliente-filter");
        const clienteSeleccionado = select?.value || "";

        if (!clienteSeleccionado) {
          // Mostrar todos
          populateUnidadSelector();
          return;
        }

        // Filtrar solo unidades del cliente seleccionado
        const unidadesFiltradas = filteredDespachosData.filter(
          (d) => d.cliente === clienteSeleccionado,
        );

        // Contar registros por unidad para agregar tramos
        const unidadCount = {};
        const unidadIndex = {};
        unidadesFiltradas.forEach((d) => {
          const unidadNombre = String(d.unidad || "").trim();
          unidadCount[unidadNombre] = (unidadCount[unidadNombre] || 0) + 1;
          unidadIndex[unidadNombre] = 0;
        });

        const unidadSelect = document.getElementById("unidad-select");
        if (!unidadSelect) return;

        unidadSelect.innerHTML =
          '<option value="">-- Selecciona Unidad --</option>';

        unidadesFiltradas.forEach((d) => {
          // Determinar número de tramo si hay múltiples registros
          const unidadNombre = String(d.unidad || "").trim();
          const tieneMultiplesTramos = unidadCount[unidadNombre] > 1;
          unidadIndex[unidadNombre] = (unidadIndex[unidadNombre] || 0) + 1;
          const numeroTramo = unidadIndex[unidadNombre];
          const tramoLabel = tieneMultiplesTramos
            ? ` - Tramo ${numeroTramo}`
            : "";

          const opt = document.createElement("option");
          opt.value = d.index; // Usar índice original
          opt.textContent = `${d.unidad}${tramoLabel} - ${d.operador}`;
          unidadSelect.appendChild(opt);
        });
      }
      function populateUnidadSelector() {
        const sel = document.getElementById("unidad-selector");
        if (!sel) return;

        // Contar registros por unidad para agregar tramos
        const unidadCount = {};
        const unidadIndex = {};
        filteredDespachosData.forEach((d) => {
          const unidadNombre = String(d.unidad || "").trim();
          unidadCount[unidadNombre] = (unidadCount[unidadNombre] || 0) + 1;
          unidadIndex[unidadNombre] = 0;
        });

        sel.innerHTML = '<option value="">-- Seleccione unidad --</option>';
        filteredDespachosData.forEach((d, i) => {
          // Determinar número de tramo si hay múltiples registros
          const unidadNombre = String(d.unidad || "").trim();
          const tieneMultiplesTramos = unidadCount[unidadNombre] > 1;
          unidadIndex[unidadNombre] = (unidadIndex[unidadNombre] || 0) + 1;
          const numeroTramo = unidadIndex[unidadNombre];
          const tramoLabel = tieneMultiplesTramos
            ? ` - Tramo ${numeroTramo}`
            : "";

          sel.innerHTML += `<option value="${i}">${escapeHtml(
            d.unidad,
          )}${tramoLabel}</option>`;
        });
        document.getElementById("consulta-btn").disabled = true;
        document
          .getElementById("seguimiento-form-container")
          .classList.add("hidden");
      }

      function handleUnidadSelection(ev) {
        const idx = ev.target.value;
        const btn = document.getElementById("consulta-btn");
        if (idx === "") {
          btn.disabled = true;
          document
            .getElementById("seguimiento-form-container")
            .classList.add("hidden");
          return;
        }
        btn.disabled = false;
        renderSeguimientoForm(Number(idx));
      }

      function showUnitData() {
        const idx = document.getElementById("unidad-selector").value;
        if (idx === "") return;
        const d = filteredDespachosData[Number(idx)];
        document.getElementById("modal-body").innerHTML = `
          <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
            <p><strong>Folio:</strong></p><p>${escapeHtml(
              String(d.folio).padStart(3, "0"),
            )}</p>
            <p><strong>Unidad:</strong></p><p>${escapeHtml(d.unidad)}</p>
            <p><strong>Placas:</strong></p><p>${escapeHtml(d.placas)}</p>
            <p><strong>Operador:</strong></p><p>${escapeHtml(d.operador)}</p>
            <p><strong>Teléfono:</strong></p><p>${escapeHtml(d.telefono)}</p>
            <p><strong>Ruta:</strong></p><p>${escapeHtml(d.ruta)}</p>
            <p><strong>Origen:</strong></p><p>${escapeHtml(d.origen)}</p>
            <p><strong>Destino:</strong></p><p>${escapeHtml(d.destino)}</p>
            <p><strong>Cliente:</strong></p><p>${escapeHtml(d.cliente)}</p>
          </div>`;
        openModal("data-modal");
      }

      function getIncidenciaSeveridad(tipo) {
        const map = {
          "Desconexión de batería": "Rojo",
          "Botón de pánico": "Rojo",
          Persecución: "Rojo",
          "Accidente vehicular propio": "Rojo",
          "Robo o asalto": "Rojo",
          "Despacho No Recibido": "Rojo",
          "Ausencia de actualización": "Naranja",
          "Parada no autorizada": "Naranja",
          "Operador no contesta más de 2 veces": "Naranja",
          "Detención por faltas al reglamento de tránsito": "Naranja",
          "Falla mecánica": "Naranja",
          "Ponchadura de llantas": "Naranja",
          "Cierres carreteros": "Naranja",
          "Condiciones climatológicas": "Naranja",
          "Sin contacto con el operador": "Naranja",
          "Desvío de ruta": "Naranja",
          "Vehículo sospechoso": "Naranja",
          "Salida a destiempo": "Verde",
          "Desconocimiento de lugar de entrega": "Verde",
          "Mala actitud del Operador": "Verde",
        };
        return map[tipo] || "Verde";
      }

      function renderIncidencias(incs, despachoIndex, isEditor) {
        const list = Array.isArray(incs) ? incs : [];
        if (!list.length)
          return `<p class="text-sm text-gray-500">No hay incidencias.</p>`;

        return list
          .map((inc, incIndex) => {
            const tipo = inc && inc.tipo ? String(inc.tipo) : "Incidencia";
            const sev =
              inc && inc.severidad
                ? String(inc.severidad)
                : getIncidenciaSeveridad(tipo);
            const sevLower = sev.toLowerCase();
            const cls =
              sevLower === "rojo"
                ? "incidencia-rojo"
                : sevLower === "naranja"
                  ? "incidencia-naranja"
                  : "incidencia-verde";

            return `
            <div class="text-sm p-2 rounded-md ${cls} flex items-center justify-between gap-3">
              <div class="min-w-0">
                <strong>${escapeHtml(tipo)}</strong>
                <span class="opacity-80">— ${formatDateTime(
                  inc && inc.fecha ? inc.fecha : "",
                )}</span>
                ${
                  inc && inc.direccion
                    ? `<div class="text-xs opacity-80 mt-1">Dirección: ${escapeHtml(
                        inc.direccion,
                      )}</div>`
                    : ``
                }
              </div>
              ${
                isEditor
                  ? `<button type="button" onclick="deleteIncidencia(${despachoIndex}, ${incIndex})" class="p-1 text-red-700 hover:text-red-900" title="Eliminar incidencia">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M15 6V4c0-1-1-2-2-2h-2c-1 0-2 1-2 2v2"/>
                      </svg>
                    </button>`
                  : ``
              }
            </div>`;
          })
          .join("");
      }

      function deleteIncidencia(despachoIndex, incIndex) {
        if (userRole !== "editor") return;
        const d = filteredDespachosData[despachoIndex];
        if (!d || !Array.isArray(d.incidencias)) return;
        d.incidencias.splice(incIndex, 1);
        saveAllData();
        const el = document.getElementById("incidencias-list");
        if (el)
          el.innerHTML = renderIncidencias(d.incidencias, despachoIndex, true);

        // Actualizar estado del botón Guardar
        updateGuardarButtonState(despachoIndex);

        renderRegistroDespacho();
        renderIncidenciasExecutiveReport();
      }

      /* Protocolos (mapeo mínimo; puedes extenderlo) */
      const INCIDENCIA_PROTOCOLOS = {
        "Desconexión de batería": {
          nivel: "Crítica",
          pasos: [
            "Verificar si hubo corte de energía/tamper y hora del último ping válido.",
            "Llamar al operador (1 intento inmediato). Si no responde en 5–10 min → tratar como Crítica.",
            "Escalar a Seguridad patrimonial + Jefe de tráfico.",
            "Activar seguimiento alterno (último punto, geocercas dinámicas, etc.).",
            "Si coincide con desvío/parada/zona de riesgo → proceder como “Robo/Asalto”.",
          ],
        },
        "Botón de pánico": {
          nivel: "Crítica",
          pasos: [
            "Confirmar evento en plataforma (hora, ubicación, velocidad, rumbo).",
            "Escalar de inmediato a Seguridad + Operaciones.",
            "Intentar contacto breve con el operador (pregunta cerrada y validación con palabra clave, si existe).",
            "Mantener rastreo en vivo y registrar cambios de ruta/paradas.",
            "Activar protocolo externo (911) y notificar aseguradora/cliente si corresponde.",
          ],
        },
        Persecución: {
          nivel: "Crítica",
          pasos: [
            "Escalar inmediato a Seguridad + Operaciones.",
            "Mantener rastreo en vivo; guardar evidencias (ruta, timestamps, eventos).",
            "Indicar al operador dirigirse a punto seguro sin detenerse (según política).",
            "Activar autoridades/911 según política y ubicación.",
            "Comunicación controlada y bitácora detallada.",
          ],
        },
        "Accidente vehicular propio": {
          nivel: "Crítica",
          pasos: [
            "Confirmar estado del operador y ocupantes (lesiones / necesidad de emergencia).",
            "Si hay lesionados: activar emergencias (911) según política.",
            "Escalar a Operaciones + Seguridad (y aseguradora).",
            "Coordinar grúa/taller y continuidad (transbordo si aplica).",
            "Cierre con reporte y evidencias.",
          ],
        },
        "Robo o asalto": {
          nivel: "Crítica",
          pasos: [
            "Escalar inmediato a Seguridad + Operaciones (y aseguradora).",
            "Mantener seguimiento en vivo y preservar evidencias.",
            "Activar autoridades/911 según política y ubicación.",
            "Gestionar comunicaciones con cliente y continuidad (plan alterno).",
          ],
        },
        "Despacho No Recibido": {
          nivel: "Crítica",
          pasos: [
            "Confirmar datos del despacho: unidad, folio, destino, ventana de entrega y contacto del cliente.",
            "Validar estatus en plataforma (última ubicación GPS, ruta, geocerca de entrega, tiempos).",
            "Contactar al operador (mínimo 2 intentos) y documentar hora/resultado.",
            "Contactar al cliente / punto de entrega para confirmar si hay intento de entrega o rechazo.",
            "Solicitar evidencia disponible: confirmación verbal, fotos, sello, firma, número de recepción o referencia (si aplica).",
            "Si hay discrepancia (cliente indica NO recibido) y la unidad estuvo en zona de entrega: escalar a Seguridad/Tráfico y activar investigación interna.",
            "Si NO hay ubicación consistente o hay señales de riesgo: escalar inmediatamente a Seguridad según política y activar cadena de comunicación.",
            "Registrar en observaciones el resumen y acordar siguientes pasos (reintento, retorno, aclaración, levantamiento de reporte).",
          ],
        },

        "Ausencia de actualización": {
          nivel: "Relevante",
          pasos: [
            "Confirmar último ping y calidad de señal.",
            "Contactar operador y/o proveedor GPS si hay falla general.",
            "Escalar según umbrales y contexto (zona/horario/carga).",
          ],
        },
        "Parada no autorizada": {
          nivel: "Relevante",
          pasos: [
            "Validar duración y lugar (geocerca, punto autorizado, etc.).",
            "Contactar: motivo + tiempo estimado + confirmación de integridad (unidad/carga).",
            "Si no hay contacto o se prolonga: escalar a Tráfico; si hay riesgo → Seguridad.",
            "Registrar y ajustar ETA.",
          ],
        },
        "Operador no contesta más de 2 veces": {
          nivel: "Relevante",
          pasos: [
            "Hacer 2 intentos en 5–7 min por canales distintos.",
            "Revisar simultáneamente: desvío, paradas, ausencia de actualización, geocercas.",
            "Escalar a Tráfico; si hay condiciones de riesgo → Seguridad.",
          ],
        },
        "Detención por faltas al reglamento de tránsito": {
          nivel: "Relevante",
          pasos: [
            "Confirmar ubicación y estatus (¿detenido formalmente o infracción?).",
            "Escalar a Tráfico/Legal interno (según estructura).",
            "Ajustar ETA y notificar cliente si afecta ventana.",
            "Registrar evidencia y datos de la autoridad (si aplica).",
          ],
        },
        "Falla mecánica": {
          nivel: "Relevante",
          pasos: [
            "Indicar al operador ubicarse en punto seguro y activar intermitentes.",
            "Coordinar asistencia vial y plan de continuidad (grúa/transbordo).",
            "Actualizar ETA y notificar afectaciones.",
            "Si zona de riesgo: involucrar Seguridad.",
          ],
        },
        "Ponchadura de llantas": {
          nivel: "Relevante",
          pasos: [
            "Confirmar ubicación segura para detenerse.",
            "Activar asistencia y evaluar transbordo si impacta.",
            "Registrar tiempo fuera de operación y ajustar ETA.",
          ],
        },
        "Cierres carreteros": {
          nivel: "Relevante",
          pasos: [
            "Confirmar tramo afectado y ruta alterna autorizada.",
            "Aprobar desvío formal.",
            "Ajustar ETA, notificar cliente y registrar causa externa.",
          ],
        },
        "Condiciones climatológicas": {
          nivel: "Relevante",
          pasos: [
            "Evaluar riesgo: reducir velocidad/pausar operación según política.",
            "Ajustar ruta/ETA y notificar al cliente.",
            "Definir punto seguro si se decide paro preventivo.",
            "Registrar evento para análisis.",
          ],
        },
        "Sin contacto con el operador": {
          nivel: "Relevante",
          pasos: [
            "Hacer 2 intentos (llamada + mensaje) en 5–7 min.",
            "Verificar si hay zonas sin cobertura / ausencia de actualización.",
            "Escalar a Coordinador/Tráfico; si condición sospechosa → Seguridad.",
            "Definir acción (punto seguro / verificación física, según operación).",
          ],
        },
        "Desvío de ruta": {
          nivel: "Relevante",
          pasos: [
            "Medir distancia/tiempo fuera de ruta y si se aleja del destino.",
            "Contactar operador: motivo, ruta alterna y nueva ETA.",
            "Si no hay justificación o no responde: escalar; si empeora → Seguridad.",
            "Actualizar ETA y notificar si impacta entrega.",
          ],
        },
        "Vehículo sospechoso": {
          nivel: "Relevante",
          pasos: [
            "Contactar operador y pedir descripción breve (sin distraer).",
            "Indicar mantenerse en vías principales y dirigirse a punto seguro.",
            "Escalar a Seguridad para acompañamiento remoto.",
            "Monitorear patrones: velocidad, paradas, cambios bruscos.",
          ],
        },

        "Salida a destiempo": {
          nivel: "Ordinaria",
          pasos: [
            "Recalcular ETA y notificar al cliente/almacén.",
            "Identificar causa y corregir.",
            "Registrar para mejora (KPI puntualidad).",
          ],
        },
        "Desconocimiento de lugar de entrega": {
          nivel: "Ordinaria",
          pasos: [
            "Proveer indicaciones y contacto del cliente.",
            "Si no hay contacto: escalar y definir punto de espera seguro.",
            "Documentar para actualizar instrucciones de entrega.",
          ],
        },
        "Mala actitud del Operador": {
          nivel: "Ordinaria",
          pasos: [
            "Interacción breve y profesional: recordar procedimiento.",
            "Registrar incidente y evidencias (si aplica).",
            "Escalar a Supervisor/Operaciones para seguimiento.",
            "Si hay negativa a cumplir instrucciones críticas → elevar nivel según riesgo.",
          ],
        },
      };

      function showProtocoloIncidenciaFromSelect() {
        const sel = document.getElementById("incidencia-tipo");
        const tipo = sel ? sel.value : "";
        if (!tipo)
          return alert(
            "Seleccione un tipo de incidencia para ver el protocolo.",
          );
        showProtocoloPorTipo(tipo);
      }

      function showProtocoloPorTipo(tipo) {
        const item = INCIDENCIA_PROTOCOLOS[tipo];
        const titleEl = document.getElementById("protocolo-modal-title");
        const bodyEl = document.getElementById("protocolo-modal-body");
        if (!titleEl || !bodyEl) return;

        titleEl.textContent = `Protocolo: ${tipo}`;
        if (!item) {
          bodyEl.innerHTML = `<p class="text-gray-600">No hay protocolo configurado para esta incidencia.</p>`;
          openModal("protocolo-modal");
          return;
        }

        const badgeClass =
          item.nivel === "Crítica"
            ? "bg-red-100 text-red-800"
            : item.nivel === "Relevante"
              ? "bg-orange-100 text-orange-800"
              : "bg-green-100 text-green-800";
        bodyEl.innerHTML = `
          <div class="mb-4">
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold ${badgeClass}">
              ${item.nivel}
            </span>
          </div>
          <ol class="list-decimal ml-5 space-y-2 text-gray-700">
            ${(item.pasos || [])
              .map((p) => `<li>${escapeHtml(p)}</li>`)
              .join("")}
          </ol>`;
        openModal("protocolo-modal");
      }

      function renderSeguimientoForm(index) {
        const container = document.getElementById("seguimiento-form-container");
        const d = filteredDespachosData[index];
        if (!d) {
          container.innerHTML = "<p>No hay datos.</p>";
          container.classList.remove("hidden");
          return;
        }

        const isEditor = userRole === "editor";
        const disabled = isEditor ? "" : "disabled";
        const readOnly = isEditor ? "" : "readonly";

        const incidenciaOptions = `
          <option value="">-- Seleccione incidencia --</option>
          <optgroup label="🔴 Críticas (Rojo)">
            <option>Desconexión de batería</option>
            <option>Botón de pánico</option>
            <option>Persecución</option>
            <option>Accidente vehicular propio</option>
            <option>Robo o asalto</option>
            <option>Despacho No Recibido</option>
          </optgroup>
          <optgroup label="🟠 Relevantes (Naranja)">
            <option>Ausencia de actualización</option>
            <option>Parada no autorizada</option>
            <option>Operador no contesta más de 2 veces</option>
            <option>Detención por faltas al reglamento de tránsito</option>
            <option>Falla mecánica</option>
            <option>Ponchadura de llantas</option>
            <option>Cierres carreteros</option>
            <option>Condiciones climatológicas</option>
            <option>Sin contacto con el operador</option>
            <option>Desvío de ruta</option>
            <option>Vehículo sospechoso</option>
          </optgroup>
          <optgroup label="🟢 Ordinarias (Verde)">
            <option>Salida a destiempo</option>
            <option>Desconocimiento de lugar de entrega</option>
            <option>Mala actitud del Operador</option>
          </optgroup>`;

        const timeField = (label, name, realIso, progIso) => `
          <div>
            <label class="block text-sm font-medium text-gray-700">${label}</label>
            <input name="${name}" type="datetime-local" value="${formatForInput(
              realIso,
            )}" class="mt-1 w-full p-2 border rounded-md" ${readOnly} />
            <div class="mt-2 p-2 bg-gray-100 border border-gray-200 rounded-md text-sm text-gray-700">
              <strong>Programada:</strong> ${formatDateTime(progIso)}
            </div>
          </div>`;

        container.innerHTML = `
          <form id="form-seguimiento" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="bg-gray-50 border rounded-xl p-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">ID del Operador de Monitoreo</label>
                <select name="operadorMonitoreoId" class="w-full p-2 border rounded-md" ${disabled}>
                  <option value="">-- Seleccione --</option>
                  ${["GEO-01", "GEO-02", "GEO-03", "GEO-04", "GEO-05", "GEO-06"]
                    .map(
                      (v) =>
                        `<option value="${v}" ${
                          d.operadorMonitoreoId === v ? "selected" : ""
                        }>${v}</option>`,
                    )
                    .join("")}
                </select>
              </div>

              <div class="bg-gray-50 border rounded-xl p-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Validación GPS y accesorios</label>
                <select name="gpsValidacionEstado" class="w-full p-2 border rounded-md" ${disabled}>
                  <option value="">-- Seleccione --</option>
                  <option value="Operativo" ${
                    String(d.gpsValidacionEstado).toLowerCase() === "operativo"
                      ? "selected"
                      : ""
                  }>Operativo</option>
                  <option value="No Operativo" ${
                    String(d.gpsValidacionEstado).toLowerCase() ===
                    "no operativo"
                      ? "selected"
                      : ""
                  }>No Operativo</option>
                </select>
                <p class="mt-2 text-xs text-gray-500">Última validación: <span class="font-semibold">${
                  d.gpsValidacionTimestamp
                    ? formatDateTime(d.gpsValidacionTimestamp)
                    : "Sin registro"
                }</span></p>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              ${timeField(
                "Salida inicial de la Unidad (Real)",
                "realSalidaUnidad",
                d.realSalidaUnidad,
                d.citaSalidaUnidad,
              )}
              ${timeField(
                "Cita de Carga (Real)",
                "realCarga",
                d.realCarga,
                d.citaCarga,
              )}
              ${timeField(
                "Salida de carga (Real)",
                "realSalida",
                d.realSalida,
                d.citaSalida,
              )}
              ${timeField(
                "Proceso de Descarga (Real)",
                "realDescarga",
                d.realDescarga,
                d.citaDescarga,
              )}
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium">Confirmación de Entrega</label>
                <select name="confirmacionEntrega" class="mt-1 w-full p-2 border rounded-md" ${disabled}>
                  <option value="">-- Seleccione --</option>
                  <option value="SI" ${
                    d.confirmacionEntrega === "SI" ? "selected" : ""
                  }>SI</option>
                  <option value="NO" ${
                    d.confirmacionEntrega === "NO" ? "selected" : ""
                  }>NO</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium">Estatus</label>
                <select name="estatus" class="mt-1 w-full p-2 border rounded-md" ${disabled}>
                  ${[
                    "Programado",
                    "En ruta",
                    "Despacho realizado",
                    "Despacho No realizado",
                    "Cancelado",
                  ]
                    .map(
                      (v) =>
                        `<option ${
                          d.estatus === v ? "selected" : ""
                        }>${v}</option>`,
                    )
                    .join("")}
                </select>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium">Observaciones</label>
              <textarea name="observaciones" rows="3" class="mt-1 w-full p-2 border rounded-md" ${readOnly}>${escapeHtml(
                d.observaciones || "",
              )}</textarea>
            </div>

            <div class="mt-4 border-t pt-4 grid grid-cols-1 gap-4">
              <div>
                <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
                  <div class="text-sm text-gray-600">
                    Incidencias: <strong>${
                      (d.incidencias || []).length
                    }</strong>
                  </div>

                  <div class="flex items-center gap-2 flex-wrap">
                    <select id="incidencia-tipo" class="p-2 border rounded-md w-72" ${disabled} onchange="handleIncidenciaTipoChange()">
                      ${incidenciaOptions}
                    </select>

                    <div id="incidencia-direccion-wrapper" class="hidden w-full md:w-[32rem]">

                    <label class="block text-sm font-medium text-gray-700">Dirección de ocurrencia</label>

                    <input

                      id="incidencia-direccion"

                      type="text"

                      placeholder="Ej. Km 43 Aut. México-Querétaro, Col. ..., Municipio, Estado"

                      class="mt-1 w-full p-2 border rounded-md"

                      ${disabled}

                    />

                    <p class="text-xs text-gray-500 mt-1">

                      Se guardará junto a la incidencia y se verá en el Informe Ejecutivo.

                    </p>

                  </div>

                    <button type="button" onclick="addIncidencia(${index})" ${disabled}
                      class="bg-slate-700 text-white px-4 py-2 rounded-md hover:bg-slate-800 disabled:bg-gray-400">
                      Agregar
                    </button>

                    <button type="button" onclick="showProtocoloIncidenciaFromSelect()"
                      class="bg-emerald-600 text-white px-4 py-2 rounded-md hover:bg-emerald-700">
                      Ver protocolo
                    </button>

                    <button type="button" id="btn-guardar-seguimiento-${index}" onclick="saveSeguimiento(${index})" ${disabled}
                      class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 disabled:bg-gray-400">
                      Guardar
                    </button>
                  </div>
                </div>

                <div class="space-y-2" id="incidencias-list">
                  ${renderIncidencias(d.incidencias || [], index, isEditor)}
                </div>
              </div>
            </div>
          </form>`;
        container.classList.remove("hidden");
        setTimeout(() => {
          handleIncidenciaTipoChange();
          updateGuardarButtonState(index);
        }, 0);
      }

      // Validar estado del botón Guardar - siempre habilitado para editores
      function updateGuardarButtonState(index) {
        const btn = document.getElementById(`btn-guardar-seguimiento-${index}`);
        if (!btn || userRole !== "editor") return;

        // El botón siempre está habilitado para editores
        // Se puede guardar con o sin incidencias
        btn.disabled = false;
        btn.title = "Guardar seguimiento";
      }

      // ✅ ÚNICA addIncidencia (con envío a Make)
      function addIncidencia(index) {
        if (userRole !== "editor") return;

        const sel = document.getElementById("incidencia-tipo");
        const tipo = sel ? sel.value : "";
        if (!tipo) return alert("Seleccione una incidencia.");

        const dirInput = document.getElementById("incidencia-direccion");

        const direccion = (dirInput?.value || "").trim();

        if (!direccion)
          return alert("Ingrese la dirección de ocurrencia de la incidencia.");

        const d = filteredDespachosData[index];
        if (!d) return;

        d.incidencias = Array.isArray(d.incidencias) ? d.incidencias : [];

        const incObj = {
          tipo,
          fecha: new Date().toISOString(),
          severidad: getIncidenciaSeveridad(tipo),
          direccion, // ✅ PARCHE: dirección guardada
        };

        d.incidencias.push(incObj);

        saveAllData();

        const el = document.getElementById("incidencias-list");
        if (el) el.innerHTML = renderIncidencias(d.incidencias, index, true);

        // Habilitar botón Guardar después de agregar incidencia
        updateGuardarButtonState(index);

        renderRegistroDespacho();
        renderIncidenciasExecutiveReport();

        try {
          if (sel) sel.value = "";

          if (dirInput) dirInput.value = "";

          handleIncidenciaTipoChange();
        } catch (e) {}

        // ---- Enviar incidencia a Make (no bloquea la UI) ----
        try {
          const datosIncidencia = {
            titulo: `Incidencia ${incObj.severidad}: ${tipo} | Unidad ${
              d.unidad
            } | Folio ${String(d.folio).padStart(3, "0")}`,
            cuerpo: [
              `Unidad: ${d.unidad || "N/A"}`,
              `Folio: ${String(d.folio || "")}`,
              `Fecha programada: ${d.fechaProgramada || ""}`,
              `Operador: ${d.operador || "N/A"}`,
              `Teléfono: ${d.telefono || "N/A"}`,
              `Ruta: ${d.ruta || "N/A"}`,
              `Origen: ${d.origen || "N/A"}`,
              `Destino: ${d.destino || "N/A"}`,
              `Severidad: ${incObj.severidad}`,
              `Estatus: ${d.estatus || "Programado"}`,
              `Dirección: ${incObj.direccion || "N/A"}`,
            ].join("\n"),
            // Campos individuales para Make.com
            direccion: incObj.direccion || "",
            unidad: d.unidad || "",
            folio: String(d.folio || ""),
            operador: d.operador || "",
            telefono: d.telefono || "",
            ruta: d.ruta || "",
            origen: d.origen || "",
            destino: d.destino || "",
            severidad: incObj.severidad || "",
            tipoIncidencia: tipo || "",
          };
          enviarIncidencia(datosIncidencia);
        } catch (e) {
          console.warn("No se pudo preparar/enviar la incidencia a Make:", e);
        }
      }

      // Variable para almacenar el índice pendiente de guardar
      let pendingSaveIndex = null;

      function saveSeguimiento(index) {
        if (userRole !== "editor") return;

        const d = filteredDespachosData[index];

        // Si no hay incidencias, mostrar modal de confirmación
        const hasIncidencias =
          Array.isArray(d?.incidencias) && d.incidencias.length > 0;
        if (!hasIncidencias) {
          pendingSaveIndex = index;
          document
            .getElementById("confirm-save-modal")
            .classList.remove("hidden");
          return;
        }

        executeSaveSeguimiento(index);
      }

      function closeConfirmSaveModal(confirmed) {
        document.getElementById("confirm-save-modal").classList.add("hidden");
        if (confirmed && pendingSaveIndex !== null) {
          executeSaveSeguimiento(pendingSaveIndex);
        }
        pendingSaveIndex = null;
      }

      function executeSaveSeguimiento(index) {
        const d = filteredDespachosData[index];
        const form = document.getElementById("form-seguimiento");

        d.operadorMonitoreoId =
          form.elements["operadorMonitoreoId"]?.value || "";
        d.gpsValidacionEstado =
          form.elements["gpsValidacionEstado"]?.value || "";
        // Actualizar timestamp solo si cambió el estado
        if (form.elements["gpsValidacionEstado"]?.value) {
          d.gpsValidacionTimestamp = new Date().toISOString();
        }

        d.realSalidaUnidad = form.elements["realSalidaUnidad"]?.value || "";
        d.realCarga = form.elements["realCarga"]?.value || "";
        d.realSalida = form.elements["realSalida"]?.value || "";
        d.realDescarga = form.elements["realDescarga"]?.value || "";
        d.confirmacionEntrega =
          form.elements["confirmacionEntrega"]?.value || null;

        const est = form.elements["estatus"]?.value;
        // Prioridad: 1) Confirmación de entrega, 2) Estatus seleccionado manualmente
        if (d.confirmacionEntrega === "SI") {
          d.estatus = "Despacho realizado";
        } else if (d.confirmacionEntrega === "NO") {
          d.estatus = "Despacho No realizado";
        } else {
          // Respetar el estatus seleccionado manualmente por el usuario
          d.estatus = est;
        }

        d.observaciones = form.elements["observaciones"]?.value || "";

        saveAllData();
        renderAllTabs();
        document.getElementById("unidad-selector").value = String(index);
        renderSeguimientoForm(index);

        // Guardar también en BD
        saveSeguimientoToDb(filteredDespachosData[index]).catch((err) => {
          console.error("Error guardando seguimiento en BD", err);
        });
      }

      /* ===========================
    Seguimiento en BD (MySQL)
=========================== */
      const SEGUIMIENTO_SAVE_ENDPOINT =
        "/bitacora_/src/seguimiento/guardar_seguimiento.php";
      const SEGUIMIENTO_LOAD_ENDPOINT =
        "/bitacora_/src/seguimiento/obtener_seguimiento.php";

      let seguimientosDbCache = {
        loaded: false,
        map: new Map(),
      };

      function makeSeguimientoKey(folio, unidad, fechaProgramada) {
        return `${String(folio ?? "").trim()}|${String(
          unidad ?? "",
        ).trim()}|${String(fechaProgramada ?? "").trim()}`;
      }

      function parseIncidenciasFromDbString(raw) {
        const s = (raw ?? "").toString().trim();
        if (!s) return [];
        return s
          .split(";;")
          .map((part) => part.trim())
          .filter(Boolean)
          .map((part) => {
            const pieces = part.split(" | ");
            const tipo = (pieces[0] ?? "").trim();
            const severidad = (pieces[1] ?? "").trim();
            const fecha = (pieces[2] ?? "").trim();
            const direccion = (pieces[3] ?? "").trim();
            return { tipo, severidad, fecha, direccion };
          })
          .filter((x) => x.tipo);
      }

      function normalizeSeguimientoDbRow(r) {
        const folio = r?.folio ?? "";
        const unidad = r?.unidad ?? "";
        const fechaProgramada = r?.fecha_programada ?? "";
        return {
          key: makeSeguimientoKey(folio, unidad, fechaProgramada),
          folio,
          unidad,
          fechaProgramada,

          operadorMonitoreoId: r?.operador_monitoreo ?? "",
          gpsValidacionEstado: r?.gps_estado ?? "",
          gpsValidacionTimestamp: r?.gps_timestamp ?? "",

          realSalidaUnidad: r?.real_salida_unidad ?? "",
          realCarga: r?.real_carga ?? "",
          realSalida: r?.real_salida ?? "",
          realDescarga: r?.real_descarga ?? "",

          confirmacionEntrega:
            r?.confirmacion_entrega === null ||
            typeof r?.confirmacion_entrega === "undefined"
              ? null
              : String(r.confirmacion_entrega),
          estatus: r?.estatus ?? "",
          observaciones: r?.observaciones ?? "",
          incidencias: parseIncidenciasFromDbString(r?.incidencias),
        };
      }

      function applySeguimientosDbToArray(arr) {
        if (!seguimientosDbCache.loaded || !arr?.length) return;
        arr.forEach((d) => {
          const key = makeSeguimientoKey(d.folio, d.unidad, d.fechaProgramada);
          const s = seguimientosDbCache.map.get(key);
          if (!s) return;
          // BD sobreescribe campos de seguimiento
          d.operadorMonitoreoId =
            s.operadorMonitoreoId || d.operadorMonitoreoId;
          d.gpsValidacionEstado =
            s.gpsValidacionEstado || d.gpsValidacionEstado;
          d.gpsValidacionTimestamp =
            s.gpsValidacionTimestamp || d.gpsValidacionTimestamp;

          d.realSalidaUnidad = s.realSalidaUnidad || d.realSalidaUnidad;
          d.realCarga = s.realCarga || d.realCarga;
          d.realSalida = s.realSalida || d.realSalida;
          d.realDescarga = s.realDescarga || d.realDescarga;

          if (s.confirmacionEntrega !== null)
            d.confirmacionEntrega = s.confirmacionEntrega;
          d.estatus = s.estatus || d.estatus;
          d.observaciones =
            typeof s.observaciones === "string" && s.observaciones.trim()
              ? s.observaciones
              : d.observaciones;

          if (Array.isArray(s.incidencias) && s.incidencias.length)
            d.incidencias = s.incidencias;
        });
      }

      async function loadSeguimientosFromDb() {
        const res = await fetch(
          `${SEGUIMIENTO_LOAD_ENDPOINT}?_=${Date.now()}`,
          {
            cache: "no-store",
          },
        );

        let json = null;
        try {
          json = await res.clone().json();
        } catch (_) {
          json = null;
        }

        if (!res.ok) {
          const msg = json?.message
            ? String(json.message)
            : `HTTP ${res.status}`;
          throw new Error(msg);
        }

        if (!json) json = await res.json();
        const rows = Array.isArray(json?.data)
          ? json.data
          : Array.isArray(json)
            ? json
            : [];

        const m = new Map();
        rows.forEach((r) => {
          const s = normalizeSeguimientoDbRow(r);
          if (s.key) m.set(s.key, s);
        });

        seguimientosDbCache.map = m;
        seguimientosDbCache.loaded = true;
        // Aplicar a los datos actuales
        applySeguimientosDbToArray(allDespachosData);
        applySeguimientosDbToArray(filteredDespachosData);
      }

      async function saveSeguimientoToDb(d) {
        const payload = {
          folio: d.folio,
          unidad: d.unidad,
          fechaProgramada: d.fechaProgramada,
          operadorMonitoreoId: d.operadorMonitoreoId || "",
          gpsValidacionEstado: d.gpsValidacionEstado || "",
          gpsValidacionTimestamp: d.gpsValidacionTimestamp || "",
          realSalidaUnidad: d.realSalidaUnidad || "",
          realCarga: d.realCarga || "",
          realSalida: d.realSalida || "",
          realDescarga: d.realDescarga || "",
          confirmacionEntrega: d.confirmacionEntrega,
          estatus: d.estatus || "",
          observaciones: d.observaciones || "",
          incidencias: Array.isArray(d.incidencias) ? d.incidencias : [],
        };

        const res = await fetch(
          `${SEGUIMIENTO_SAVE_ENDPOINT}?_=${Date.now()}`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          },
        );

        let json = null;
        try {
          json = await res.clone().json();
        } catch (_) {
          json = null;
        }

        if (!res.ok || json?.success !== true) {
          const msg = json?.message
            ? String(json.message)
            : `HTTP ${res.status}`;
          throw new Error(msg);
        }

        // Actualizar cache local inmediatamente
        const key = makeSeguimientoKey(d.folio, d.unidad, d.fechaProgramada);
        seguimientosDbCache.map.set(key, {
          key,
          folio: d.folio,
          unidad: d.unidad,
          fechaProgramada: d.fechaProgramada,
          operadorMonitoreoId: d.operadorMonitoreoId || "",
          gpsValidacionEstado: d.gpsValidacionEstado || "",
          gpsValidacionTimestamp: d.gpsValidacionTimestamp || "",
          realSalidaUnidad: d.realSalidaUnidad || "",
          realCarga: d.realCarga || "",
          realSalida: d.realSalida || "",
          realDescarga: d.realDescarga || "",
          confirmacionEntrega: d.confirmacionEntrega,
          estatus: d.estatus || "",
          observaciones: d.observaciones || "",
          incidencias: Array.isArray(d.incidencias) ? d.incidencias : [],
        });
        seguimientosDbCache.loaded = true;

        // Re-render matriz/KPIs con lo más nuevo
        renderRegistroDespacho();
        renderKPIs(filteredDespachosData);
        renderIncidenciasExecutiveReport();

        return json;
      }

      /* ===========================
   TAB 3 Matriz
=========================== */
      function populateRegistroFilter() {
        // Poblar filtro por estatus
        const selEstatus = document.getElementById("registro-unidad-filter");
        if (selEstatus) {
          selEstatus.innerHTML =
            '<option value="all">Todos los estatus</option>';

          const estatusSet = new Set();
          (filteredDespachosData || []).forEach((d) => {
            const est = String(d.estatus || "Sin estatus").trim();
            estatusSet.add(est);
          });

          const ordenEstatus = [
            "Programado",
            "En ruta",
            "Despacho realizado",
            "Despacho No realizado",
            "Cancelado",
            "Sin estatus",
          ];

          const estatusOrdenados = ordenEstatus.filter((e) =>
            estatusSet.has(e),
          );

          estatusSet.forEach((e) => {
            if (!ordenEstatus.includes(e)) {
              estatusOrdenados.push(e);
            }
          });

          estatusOrdenados.forEach((e) => {
            selEstatus.innerHTML += `<option value="${escapeHtml(
              e,
            )}">${escapeHtml(e)}</option>`;
          });
        }

        // Poblar filtro por unidad
        const selUnidad = document.getElementById("registro-unidades-filter");
        if (selUnidad) {
          selUnidad.innerHTML =
            '<option value="all">Todas las unidades</option>';

          const unidadesSet = new Set();
          (filteredDespachosData || []).forEach((d) => {
            const unidad = String(d.unidad || "").trim();
            if (unidad) unidadesSet.add(unidad);
          });

          // Ordenar unidades alfabéticamente
          const unidadesOrdenadas = Array.from(unidadesSet).sort((a, b) =>
            a.localeCompare(b, "es", { sensitivity: "base" }),
          );

          unidadesOrdenadas.forEach((u) => {
            selUnidad.innerHTML += `<option value="${escapeHtml(
              u,
            )}">${escapeHtml(u)}</option>`;
          });
        }
      }

      function renderRegistroDespacho() {
        const container = document.getElementById("registro-board-container");
        const filterEstatus = document.getElementById("registro-unidad-filter");
        const filterUnidad = document.getElementById(
          "registro-unidades-filter",
        );
        container.innerHTML = "";

        let data = filteredDespachosData || [];

        // Aplicar filtro por estatus
        if (filterEstatus && filterEstatus.value !== "all") {
          data = data.filter(
            (d) =>
              String(d.estatus || "").trim() ===
              String(filterEstatus.value || "").trim(),
          );
        }

        // Aplicar filtro por unidad
        if (filterUnidad && filterUnidad.value !== "all") {
          data = data.filter(
            (d) =>
              String(d.unidad || "").trim() ===
              String(filterUnidad.value || "").trim(),
          );
        }

        if (!data.length) {
          container.innerHTML = `<div class="text-center p-6">No hay despachos para mostrar.</div>`;
          return;
        }

        // Contar registros por unidad para agregar tramos
        const unidadCount = {};
        const unidadIndex = {};
        data.forEach((d) => {
          const unidadNombre = String(d.unidad || "").trim();
          unidadCount[unidadNombre] = (unidadCount[unidadNombre] || 0) + 1;
          unidadIndex[unidadNombre] = 0;
        });

        const board = document.createElement("div");
        board.className = "registro-board";

        const header = document.createElement("div");
        header.className = "board-row";
        [
          "Unidad",
          "Salida inicial de la Unidad",
          "Proceso de Carga",
          "Salida de carga",
          "Proceso de Descarga",
          "Estatus",
        ].forEach((h) => {
          const cell = document.createElement("div");
          cell.className = "board-cell";
          cell.textContent = h;
          cell.setAttribute("data-label", h);
          header.appendChild(cell);
        });
        board.appendChild(header);

        data.forEach((d) => {
          const row = document.createElement("div");
          row.className = "board-row";

          // Determinar número de tramo si hay múltiples registros
          const unidadNombre = String(d.unidad || "").trim();
          const tieneMultiplesTramos = unidadCount[unidadNombre] > 1;
          unidadIndex[unidadNombre] = (unidadIndex[unidadNombre] || 0) + 1;
          const numeroTramo = unidadIndex[unidadNombre];
          const tramoLabel = tieneMultiplesTramos
            ? ` - Tramo ${numeroTramo}`
            : "";

          const gpsOk =
            String(d.gpsValidacionEstado || "")
              .trim()
              .toLowerCase() === "operativo";
          const dotClass = gpsOk ? "bg-green-500" : "bg-red-500";

          const uc = document.createElement("div");
          uc.className = "board-cell unit-cell";
          uc.setAttribute("data-label", "Unidad");
          uc.innerHTML = `
            <div class="flex items-center justify-center gap-2">
              <span class="inline-block w-3 h-3 rounded-full ${dotClass}" title="GPS: ${escapeHtml(
                d.gpsValidacionEstado || "Sin registro",
              )}"></span>
              <strong>${escapeHtml(d.unidad)}${tramoLabel}</strong>
            </div>
            <p class="text-xs">${escapeHtml(d.placas)}</p>
            <p class="text-xs italic">${
              d.operadorMonitoreoId
                ? "Operador: " + escapeHtml(d.operadorMonitoreoId)
                : ""
            }</p>
            <p class="text-xs italic">GPS: ${escapeHtml(
              d.gpsValidacionEstado || "Sin registro",
            )}</p>
        `;
          row.appendChild(uc);

          const tasks = [
            {
              label: "Salida inicial de la Unidad",
              cita: d.citaSalidaUnidad,
              real: d.realSalidaUnidad,
            },
            { label: "Proceso de Carga", cita: d.citaCarga, real: d.realCarga },
            {
              label: "Salida de carga",
              cita: d.citaSalida,
              real: d.realSalida,
            },
            {
              label: "Proceso de Descarga",
              cita: d.citaDescarga,
              real: d.realDescarga,
            },
          ];
          tasks.forEach((t) => {
            const cell = document.createElement("div");
            const cls = t.real
              ? checkTimeDeviation(t.cita, t.real)
              : "task-cell";
            cell.className = `board-cell ${cls}`;
            cell.setAttribute("data-label", t.label);
            cell.innerHTML = `<p class="text-xs">Prog: ${formatDateTime(
              t.cita,
            )}</p><p class="font-semibold">Real: ${
              t.real ? formatDateTime(t.real) : "-"
            }</p>`;
            row.appendChild(cell);
          });

          const statusCell = document.createElement("div");
          let stClass = "task-cell";
          if (d.estatus === "En ruta") stClass = "estatus-en-ruta";
          else if (d.estatus === "Despacho realizado")
            stClass = "estatus-verde";
          else if (d.estatus === "Despacho No realizado")
            stClass = "estatus-rojo";
          else if (d.estatus === "Cancelado") stClass = "estatus-cancelado";
          statusCell.className = `board-cell ${stClass}`;
          statusCell.setAttribute("data-label", "Estatus");
          statusCell.textContent = d.estatus || "Sin estatus";
          row.appendChild(statusCell);

          board.appendChild(row);
        });

        container.appendChild(board);
      }

      /* ===========================
   TAB 4 KPIs
=========================== */
      function renderKPIs(data) {
        const total = data.length;
        const realizados = data.filter(
          (d) => d.estatus === "Despacho realizado",
        );
        const enRuta = data.filter((d) => d.estatus === "En ruta");
        const programados = data.filter((d) => d.estatus === "Programado");
        const cancelados = data.filter((d) => d.estatus === "Cancelado");
        const aTiempo = realizados.filter(
          (d) =>
            d.realDescarga &&
            checkTimeDeviation(d.citaDescarga, d.realDescarga) ===
              "estatus-verde",
        );
        const conRetraso = realizados.length - aTiempo.length;

        document.getElementById("kpi-total-despachos").textContent = total;
        document.getElementById("kpi-despachos-a-tiempo").textContent =
          aTiempo.length;
        document.getElementById("kpi-despachos-retraso").textContent =
          conRetraso;
        document.getElementById("kpi-despachos-en-ruta").textContent =
          enRuta.length;
        document.getElementById("kpi-despachos-programados").textContent =
          programados.length;
        document.getElementById("kpi-despachos-cancelados").textContent =
          cancelados.length;

        const incCount = {};
        data.forEach((d) =>
          (d.incidencias || []).forEach((i) => {
            incCount[i.tipo] = (incCount[i.tipo] || 0) + 1;
          }),
        );
        updateCumplimientoChart([
          aTiempo.length,
          conRetraso,
          enRuta.length,
          programados.length,
          cancelados.length,
        ]);
        updateIncidenciasChart(incCount);
      }

      function updateCumplimientoChart(vals) {
        const ctx = document
          .getElementById("kpi-cumplimiento-chart")
          .getContext("2d");
        if (charts.cumplimiento) charts.cumplimiento.destroy();
        charts.cumplimiento = new Chart(ctx, {
          type: "bar",
          data: {
            labels: [
              "A Tiempo",
              "Con Retraso",
              "En Ruta",
              "Programados",
              "Cancelados",
            ],
            datasets: [
              {
                data: vals,
                backgroundColor: [
                  "#16a34a", // Verde - A Tiempo (bg-green-600)
                  "#dc2626", // Rojo - Con Retraso (bg-red-600)
                  "#ca8a04", // Amarillo - En Ruta (bg-yellow-600)
                  "#2563eb", // Azul - Programados (bg-blue-600)
                  "#6090fa", // Azul - Cancelados (bg-blue-600)
                ],
                borderRadius: 4,
                barThickness: 30,
              },
            ],
          },
          options: {
            indexAxis: "y",
            plugins: {
              legend: { display: false },
              datalabels: {
                anchor: "end",
                align: "right",
                offset: 8,
                color: "#111827",
                font: { size: 12, weight: "700" },
              },
            },
            responsive: true,
          },
        });
      }

      function updateIncidenciasChart(map) {
        const ctx = document
          .getElementById("kpi-incidencias-chart")
          .getContext("2d");
        if (charts.incidencias) charts.incidencias.destroy();
        const labels = Object.keys(map);
        const values = Object.values(map);
        if (!labels.length) {
          charts.incidencias = new Chart(ctx, {
            type: "doughnut",
            data: { labels: ["Sin incidencias"], datasets: [{ data: [1] }] },
            options: { plugins: { legend: { display: false } } },
          });
          return;
        }
        charts.incidencias = new Chart(ctx, {
          type: "doughnut",
          data: { labels, datasets: [{ data: values, borderWidth: 3 }] },
          options: { plugins: { legend: { position: "bottom" } } },
        });
      }

      /* ===========================
   TAB 5 Informe + Excel
=========================== */
      function renderInforme(data) {
        const c = document.getElementById("informe-container");
        const btn = document.getElementById("download-excel-report-btn");

        // Aplicar el mismo filtro de fecha que en las incidencias
        const window = getIncExecutiveDateWindow();
        const from = window.from || "";
        const to = window.to || "";

        let filteredData = data.slice();
        if (from && to) {
          filteredData = filteredData.filter(
            (d) => d.fechaProgramada >= from && d.fechaProgramada <= to,
          );
        } else if (from && !to) {
          filteredData = filteredData.filter((d) => d.fechaProgramada >= from);
        } else if (!from && to) {
          filteredData = filteredData.filter((d) => d.fechaProgramada <= to);
        }

        if (!filteredData.length) {
          c.innerHTML = `<p class="text-center p-6 bg-gray-100 rounded-lg">No hay datos para generar informe con el filtro seleccionado.</p>`;
          btn.disabled = true;
          lastInformeData = [];
          return;
        }
        lastInformeData = filteredData.slice();
        btn.disabled = false;

        const total = filteredData.length;
        const incs = filteredData.reduce(
          (a, d) => a + (d.incidencias || []).length,
          0,
        );
        c.innerHTML = `
          <div class="bg-white border rounded-xl p-4">
            <p class="text-gray-800 font-semibold">Resumen</p>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3">
              <div class="bg-gray-50 border rounded-lg p-3"><p class="text-xs text-gray-500">Total</p><p class="text-2xl font-bold">${total}</p></div>
              <div class="bg-yellow-50 border rounded-lg p-3"><p class="text-xs text-gray-500">Incidencias</p><p class="text-2xl font-bold">${incs}</p></div>
              <div class="bg-green-50 border rounded-lg p-3"><p class="text-xs text-gray-500">Realizados</p><p class="text-2xl font-bold">${
                filteredData.filter((d) => d.estatus === "Despacho realizado")
                  .length
              }</p></div>
              <div class="bg-blue-50 border rounded-lg p-3"><p class="text-xs text-gray-500">En Ruta</p><p class="text-2xl font-bold">${
                filteredData.filter((d) => d.estatus === "En ruta").length
              }</p></div>
            </div>
          </div>

          <div class="bg-white border rounded-xl p-4 pt-2">
            <h3 class="text-lg font-semibold pl-4">Detalle</h3>
            <div class="overflow-x-auto">
            <table class="min-w-full text-sm border rounded-lg overflow-hidden">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-2 text-left">Unidad</th>
                  <th class="px-4 py-2 text-left">Ruta</th>
                  <th class="px-4 py-2 text-left">Estatus</th>
                  <th class="px-4 py-2 text-left">Prog. Descarga</th>
                  <th class="px-4 py-2 text-left">Real Descarga</th>
                  <th class="px-4 py-2 text-left min-w-[200px]">Observaciones</th>
                </tr>
              </thead>
              <tbody class="divide-y bg-white">
                ${filteredData
                  .map(
                    (d) => `
                  <tr>
                    <td class="px-4 py-2 font-semibold">${escapeHtml(
                      d.unidad,
                    )}</td>
                    <td class="px-4 py-2">${escapeHtml(d.ruta)}</td>
                    <td class="px-4 py-2">${escapeHtml(d.estatus)}</td>
                    <td class="px-4 py-2">${formatDateTime(d.citaDescarga)}</td>
                    <td class="px-4 py-2 font-semibold">${formatDateTime(
                      d.realDescarga,
                    )}</td>
                    <td class="px-4 py-2 text-gray-600 text-xs">${escapeHtml(
                      d.observaciones || "-",
                    )}</td>
                  </tr>
                `,
                  )
                  .join("")}
              </tbody>
            </table>
            </div>
          </div>
          `;
      }

      function downloadReportAsExcel() {
        if (!lastInformeData.length)
          return alert("No hay datos para exportar.");
        const rows = lastInformeData.map((d) => ({
          Fecha: d.fechaProgramada
            ? dayjs(d.fechaProgramada).format("DD/MM/YYYY")
            : "",
          Folio: d.folio,
          Unidad: d.unidad,
          Placas: d.placas,
          Operador: d.operador,
          Telefono: d.telefono,
          Ruta: d.ruta,
          Origen: d.origen,
          Destino: d.destino,
          Estatus: d.estatus,
          "Prog Descarga": formatDateTime(d.citaDescarga),
          "Real Descarga": formatDateTime(d.realDescarga),
          Observaciones: d.observaciones || "",
          Incidencias: (d.incidencias || [])
            .map((i) => `${i.tipo} (${formatDateTime(i.fecha)})`)
            .join("; "),
          "Direccion de Incidencias": (d.incidencias || [])
            .map((i) => i.direccion || "N/A")
            .join("; "),
        }));
        const ws = XLSX.utils.json_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Informe");
        XLSX.writeFile(
          wb,
          `Informe_Detallado_${dayjs().format("YYYY-MM-DD")}.xlsx`,
        );
      }

      function exportUpdatedSheet() {
        if (!allDespachosData.length)
          return alert("No hay datos para exportar.");
        const rows = allDespachosData.map((d) => ({
          Fecha: d.fechaProgramada
            ? dayjs(d.fechaProgramada).format("DD/MM/YYYY")
            : "",
          Folio: d.folio,
          Unidad: d.unidad,
          Placas: d.placas,
          Operador: d.operador,
          Telefono: d.telefono,
          Ruta: d.ruta,
          Origen: d.origen,
          Destino: d.destino,
          "Prog Salida Unidad": formatDateTime(d.citaSalidaUnidad),
          "Real Salida Unidad": formatDateTime(d.realSalidaUnidad),
          "Prog Carga": formatDateTime(d.citaCarga),
          "Real Carga": formatDateTime(d.realCarga),
          "Prog Salida Carga": formatDateTime(d.citaSalida),
          "Real Salida Carga": formatDateTime(d.realSalida),
          "Prog Descarga": formatDateTime(d.citaDescarga),
          "Real Descarga": formatDateTime(d.realDescarga),
          ConfirmacionEntrega: d.confirmacionEntrega,
          Estatus: d.estatus,
          Observaciones: d.observaciones || "",
          Incidencias: (d.incidencias || [])
            .map((i) => `${i.tipo} (${formatDateTime(i.fecha)})`)
            .join("; "),
          "Dirección de Incidencias": (d.incidencias || [])
            .map((i) => i.direccion || "N/A")
            .join("; "),
        }));
        const ws = XLSX.utils.json_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Bitacora");
        XLSX.writeFile(
          wb,
          `Bitacora_Actualizada_${dayjs().format("YYYY-MM-DD")}.xlsx`,
        );
      }

      /* ===========================
   911: versión embebida (fallback)
=========================== */
      const EMBEDDED_911_DATA = [
        {
          estado: "CIUDAD DE MEXICO",
          municipio: "CIUDAD DE MEXICO",
          tel: "5556581111",
        },
        { estado: "ESTADO DE MEXICO", municipio: "TOLUCA", tel: "7222152865" },
        { estado: "JALISCO", municipio: "GUADALAJARA", tel: "3336681900" },
        { estado: "NUEVO LEON", municipio: "MONTERREY", tel: "8183457755" },
        { estado: "PUEBLA", municipio: "PUEBLA", tel: "2223094800" },
        { estado: "QUERETARO", municipio: "QUERETARO", tel: "4422115100" },
        { estado: "VERACRUZ", municipio: "XALAPA", tel: "2288419700" },
      ];

      let emergency911Cache = {
        loaded: false,
        rows: [],
        filtered: [],
        states: [],
        pageSize: 100,
        currentLimit: 100,
      };

      const EMERGENCY_911_ENDPOINT =
        "/bitacora_/src/contactos/obtener_numeros_emergencia.php";

      function normalizeEmergency911Row(r) {
        const estado = (r?.estado ?? "").toString().trim().toUpperCase();
        const municipio = (r?.municipio ?? "").toString().trim().toUpperCase();
        const tel = (r?.tel ?? "").toString().trim();
        return { estado, municipio, tel };
      }

      async function loadEmergency911RowsFromDb() {
        const url = `${EMERGENCY_911_ENDPOINT}?_=${Date.now()}`;
        const res = await fetch(url, { cache: "no-store" });

        // Intentar leer JSON incluso en HTTP 4xx/5xx para tener un mensaje útil
        let json = null;
        try {
          json = await res.clone().json();
        } catch (_) {
          json = null;
        }

        if (!res.ok) {
          const msg = json?.message
            ? String(json.message)
            : `HTTP ${res.status}`;
          throw new Error(msg);
        }

        if (!json) json = await res.json();
        if (!json || json.success !== true)
          throw new Error(json?.message || "Respuesta no exitosa");
        const rows = Array.isArray(json.data) ? json.data : [];
        return rows
          .map(normalizeEmergency911Row)
          .filter((x) => x.estado || x.municipio || x.tel);
      }

      async function openEmergency911Modal() {
        const statusEl = document.getElementById("em911-status");
        const tbodyEl = document.getElementById("em911-tbody");

        const fallback =
          typeof EMBEDDED_911_DATA !== "undefined" &&
          Array.isArray(EMBEDDED_911_DATA)
            ? EMBEDDED_911_DATA
            : [];

        if (!emergency911Cache.loaded) {
          if (statusEl)
            statusEl.textContent = "Cargando números de emergencia…";
          if (tbodyEl)
            tbodyEl.innerHTML =
              '<tr><td class="px-4 py-4 text-gray-500" colspan="3">Cargando…</td></tr>';

          try {
            const dbRows = await loadEmergency911RowsFromDb();
            emergency911Cache.rows = (
              dbRows.length
                ? dbRows
                : fallback.slice().map(normalizeEmergency911Row)
            ).sort((a, b) =>
              (a.estado + a.municipio).localeCompare(b.estado + b.municipio),
            );
          } catch (err) {
            console.warn(
              "No se pudo cargar números 911 desde BD, usando embebido.",
              err,
            );
            emergency911Cache.rows = fallback
              .slice()
              .map(normalizeEmergency911Row)
              .sort((a, b) =>
                (a.estado + a.municipio).localeCompare(b.estado + b.municipio),
              );
          }

          emergency911Cache.states = [
            ...new Set(emergency911Cache.rows.map((r) => r.estado)),
          ]
            .filter(Boolean)
            .sort((a, b) => a.localeCompare(b));

          const sel = document.getElementById("em911-estado");
          if (sel) {
            sel.innerHTML =
              `<option value="all">Todos los estados</option>` +
              emergency911Cache.states
                .map(
                  (s) =>
                    `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`,
                )
                .join("");
          }

          emergency911Cache.loaded = true;
        }

        applyEmergency911Filters();
        openModal("emergency911-modal");
      }

      function applyEmergency911Filters() {
        const estado = document.getElementById("em911-estado")?.value || "all";
        const term = (document.getElementById("em911-search")?.value || "")
          .trim()
          .toLowerCase();
        let f = emergency911Cache.rows;
        if (estado !== "all") f = f.filter((r) => r.estado === estado);
        if (term)
          f = f.filter((r) => (r.municipio || "").toLowerCase().includes(term));
        emergency911Cache.filtered = f;
        emergency911Cache.currentLimit = emergency911Cache.pageSize;
        renderEmergency911Table();
      }

      function loadMoreEmergency911Rows() {
        emergency911Cache.currentLimit = Math.min(
          emergency911Cache.currentLimit + emergency911Cache.pageSize,
          emergency911Cache.filtered.length,
        );
        renderEmergency911Table();
      }

      function renderEmergency911Table() {
        const total = emergency911Cache.filtered.length;
        const show = Math.min(emergency911Cache.currentLimit, total);
        document.getElementById("em911-status").textContent =
          `Mostrando ${show} de ${total} registros.`;
        const slice = emergency911Cache.filtered.slice(0, show);
        const tbody = document.getElementById("em911-tbody");
        tbody.innerHTML =
          slice
            .map(
              (r) => `
    <tr>
      <td class="px-4 py-2 whitespace-nowrap">${escapeHtml(r.estado)}</td>
      <td class="px-4 py-2">${escapeHtml(r.municipio)}</td>
      <td class="px-4 py-2 font-semibold">${escapeHtml(r.tel)}</td>
    </tr>
  `,
            )
            .join("") ||
          `<tr><td class="px-4 py-4 text-gray-500" colspan="3">Sin resultados.</td></tr>`;
      }

      let emergencyContactsCache = { loaded: false, items: [] };

      function renderEmergencyContacts(items) {
        const container = document.getElementById("emergency-contacts-body");

        if (!items || items.length === 0) {
          container.innerHTML = `
      <div class="col-span-full text-center p-10 bg-orange-50 border-2 border-orange-200 rounded-xl">
        <p class="text-lg font-medium text-orange-800 mb-2">No hay contactos disponibles</p>
        <p class="text-sm text-orange-600">Verifica la conexión con Google Sheets o añade datos en la pestaña CONTACTOS_EMERGENCIA</p>
      </div>
    `;
          return;
        }

        const html = items
          .map((contacto) => {
            const badgeClass = contacto.prioridad
              .toLowerCase()
              .includes("critica")
              ? "bg-red-100 text-red-800 border-red-300"
              : contacto.prioridad.toLowerCase().includes("alta")
                ? "bg-orange-100 text-orange-800 border-orange-300"
                : "bg-green-100 text-green-800 border-green-300";

            const telefonosHtml = contacto.telefonos.length
              ? contacto.telefonos
                  .map(
                    (tel) =>
                      `<a href="tel:${tel.replace(
                        /[\s-]/g,
                        "",
                      )}" class="text-blue-600 hover:text-blue-800 font-medium">${tel}</a>`,
                  )
                  .join(", ")
              : "Sin teléfono";

            const correosHtml = contacto.correos.length
              ? contacto.correos
                  .map(
                    (email) =>
                      `<a href="mailto:${email}" class="text-blue-600 hover:text-blue-800">${email}</a>`,
                  )
                  .join(", ")
              : "Sin correo";

            return `
      <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 hover:shadow-xl transition-all">
        <div class="flex items-start justify-between mb-4">
          <div>
            <h4 class="font-bold text-lg text-gray-900 mb-1">${escapeHtml(
              contacto.nombre,
            )}</h4>
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold ${badgeClass} border">
              ${escapeHtml(contacto.prioridad)}
            </span>
          </div>
          <div class="text-right">
            <p class="text-sm font-medium text-gray-700">Cargo/Posicion: ${escapeHtml(
              contacto.cargo,
            )}</p>
            <p class="text-xs text-gray-500">Departamento: ${escapeHtml(
              contacto.departamento,
            )}</p>
          </div>
        </div>
        
        <div class="space-y-2 text-sm mb-4">
          <div><strong>📞 Teléfonos:</strong> ${telefonosHtml}</div>
          <div><strong>✉️ Correos:</strong> ${correosHtml}</div>
          ${
            contacto.acciones
              ? `<div><strong>⚡ Acciones:</strong> ${escapeHtml(
                  contacto.acciones,
                )}</div>`
              : ""
          }
          ${
            contacto.observaciones
              ? `<div class="text-xs text-gray-600"><strong>📝 Observaciones:</strong> ${escapeHtml(
                  contacto.observaciones,
                )}</div>`
              : ""
          }
        </div>
      </div>
    `;
          })
          .join("");

        container.innerHTML = html;
      }

      async function openEmergencyContactsModal() {
        const container = document.getElementById("emergency-contacts-body");

        // Mostrar loader
        container.innerHTML = `
    <div class="col-span-full text-center p-10 bg-gray-50 rounded-xl">
      <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500 mb-4"></div>
      <p class="text-gray-600">Cargando contactos de emergencia...</p>
    </div>
  `;

        openModal("emergency-contacts-modal");

        try {
          if (
            !emergencyContactsCache.loaded ||
            !emergencyContactsCache.items.length
          ) {
            // Cargar desde Google Sheets
            const items = await loadEmergencyContactsFromSheet();

            if (items && items.length > 0) {
              emergencyContactsCache.items = items;
            } else {
              // Fallback a datos locales si Sheets está vacío
              emergencyContactsCache.items = EMERGENCYCONTACTS.slice();
            }

            emergencyContactsCache.loaded = true;
          }

          renderEmergencyContacts(emergencyContactsCache.items);
        } catch (error) {
          console.error("Error cargando contactos:", error);
          // Fallback inmediato
          renderEmergencyContacts(EMERGENCYCONTACTS);
        }
      }

      /* ===========================
   Incidencias - Informe Ejecutivo (filtros)
=========================== */
      let incExecutiveFilterMode = "selected";
      let incExecutiveRange = { from: "", to: "" };

      function setIncExecutiveFilter(mode) {
        incExecutiveFilterMode = mode;
        // UI buttons
        const all = ["selected", "today", "last7", "last30", "all"];
        all.forEach((m) => {
          const id =
            m === "last7"
              ? "incf-btn-7"
              : m === "last30"
                ? "incf-btn-30"
                : `incf-btn-${m}`;
          const btn = document.getElementById(id);
          if (!btn) return;
          const active = m === mode;
          btn.classList.toggle("bg-indigo-600", active);
          btn.classList.toggle("text-white", active);
          btn.classList.toggle("border-indigo-600", active);
          btn.classList.toggle("bg-white", !active);
          btn.classList.toggle("text-gray-700", !active);
        });
        // Actualizar tanto el resumen/detalle como las incidencias
        renderInforme(allDespachosData);
        renderIncidenciasExecutiveReport();
      }

      function applyIncExecutiveRange() {
        incExecutiveFilterMode = "range";
        incExecutiveRange.from =
          document.getElementById("incf-from")?.value || "";
        incExecutiveRange.to = document.getElementById("incf-to")?.value || "";
        // desactivar estilo de botones predefinidos
        [
          "incf-btn-selected",
          "incf-btn-today",
          "incf-btn-7",
          "incf-btn-30",
          "incf-btn-all",
        ].forEach((id) => {
          const btn = document.getElementById(id);
          if (!btn) return;
          btn.classList.remove(
            "bg-indigo-600",
            "text-white",
            "border-indigo-600",
          );
          btn.classList.add("bg-white", "text-gray-700");
        });
        // Actualizar tanto el resumen/detalle como las incidencias
        renderInforme(allDespachosData);
        renderIncidenciasExecutiveReport();
      }

      function getIncExecutiveDateWindow() {
        const selected = document.getElementById("date-filter")?.value || "";
        const today = dayjs().format("YYYY-MM-DD");

        if (incExecutiveFilterMode === "all") return { from: "", to: "" };
        if (incExecutiveFilterMode === "selected")
          return { from: selected, to: selected };
        if (incExecutiveFilterMode === "today")
          return { from: today, to: today };
        if (incExecutiveFilterMode === "last7")
          return {
            from: dayjs().subtract(6, "day").format("YYYY-MM-DD"),
            to: today,
          };
        if (incExecutiveFilterMode === "last30")
          return {
            from: dayjs().subtract(29, "day").format("YYYY-MM-DD"),
            to: today,
          };
        if (incExecutiveFilterMode === "range")
          return { from: incExecutiveRange.from, to: incExecutiveRange.to };
        return { from: selected, to: selected };
      }

      function renderIncidenciasExecutiveReport() {
        const tbody = document.getElementById("incidencias-exec-tbody");
        if (!tbody) return;

        const window = getIncExecutiveDateWindow();
        const from = window.from || "";
        const to = window.to || "";

        // Filtrar despachos por fechaProgramada dentro del rango (si aplica)
        let base = allDespachosData.slice();
        if (from && to) {
          base = base.filter(
            (d) => d.fechaProgramada >= from && d.fechaProgramada <= to,
          );
        } else if (from && !to) {
          base = base.filter((d) => d.fechaProgramada >= from);
        } else if (!from && to) {
          base = base.filter((d) => d.fechaProgramada <= to);
        }

        const rows = [];
        base.forEach((d) => {
          (d.incidencias || []).forEach((inc) => {
            const tipo = inc?.tipo || "";
            // Usar getIncidenciaSeveridad para obtener la severidad según el tipo
            const sev = inc?.severidad
              ? String(inc.severidad).toLowerCase()
              : getIncidenciaSeveridad(tipo).toLowerCase();

            rows.push({
              unidad: d.unidad || "",
              tipo: tipo,
              fecha: inc?.fecha || "",
              direccion: inc?.direccion || "",
              sev: sev,
            });
          });
        });

        const sevRank = (s) =>
          s === "rojo" ? 0 : s === "naranja" ? 1 : s === "verde" ? 2 : 3;
        rows.sort(
          (a, b) =>
            sevRank(a.sev) - sevRank(b.sev) ||
            String(a.unidad).localeCompare(String(b.unidad)),
        );

        tbody.innerHTML = rows
          .map((r) => {
            // Determinar clase CSS según la severidad (mismo sistema que renderIncidencias)
            const sevLower = String(r.sev).toLowerCase();
            const incidenciaClass =
              sevLower === "rojo"
                ? "incidencia-rojo"
                : sevLower === "naranja"
                  ? "incidencia-naranja"
                  : "incidencia-verde";

            // Badge text según severidad
            const badgeText =
              sevLower === "rojo"
                ? "🔴 CRÍTICA"
                : sevLower === "naranja"
                  ? "🟠 RELEVANTE"
                  : "🟢 ORDINARIA";

            return `
              <tr class="${incidenciaClass}">
                <td class="px-4 py-3">
                  <div class="flex items-center gap-2">
                    <span class="text-xs font-bold">${badgeText}</span>
                    <span class="font-semibold">${escapeHtml(r.unidad)}</span>
                  </div>
                </td>
                <td class="px-4 py-3 font-medium">${escapeHtml(r.tipo)}</td>
                <td class="px-4 py-3">${escapeHtml(r.fecha)}</td>
                <td class="px-4 py-3">${escapeHtml(r.direccion)}</td>
              </tr>
            `;
          })
          .join("");
        if (rows.length === 0) {
          tbody.innerHTML = `<tr><td class="px-4 py-6 text-center text-gray-500" colspan="4">Sin incidencias para el filtro seleccionado.</td></tr>`;
        }
      }

      /* ===========================
   Informes guardados (BD MySQL)
=========================== */

      async function guardarInformeEnBD() {
        if (userRole !== "editor") {
          alert("No tienes permisos para guardar informes.");
          return;
        }
        if (!lastInformeData || lastInformeData.length === 0) {
          alert("No hay datos de informe para guardar.");
          return;
        }

        const total = lastInformeData.length;
        const realizados = lastInformeData.filter(
          (d) => d.estatus === "Despacho realizado",
        );
        const aTiempo = realizados.filter(
          (d) =>
            d.realDescarga &&
            checkTimeDeviation(d.citaDescarga, d.realDescarga) ===
              "estatus-verde",
        ).length;
        const conRetraso = realizados.length - aTiempo;
        const enRuta = lastInformeData.filter(
          (d) => d.estatus === "En ruta",
        ).length;
        const programados = lastInformeData.filter(
          (d) => d.estatus === "Programado",
        ).length;
        const totalIncidencias = lastInformeData.reduce(
          (acc, d) => acc + (d.incidencias ? d.incidencias.length : 0),
          0,
        );

        const operadorMonitoreo =
          lastInformeData[0]?.operadorMonitoreoId || "Desconocido";
        const fechaDespacho =
          document.getElementById("date-filter")?.value ||
          new Date().toISOString().split("T")[0];

        const titulo = prompt(
          "Ingrese un título para el informe:",
          `Informe de Despachos - ${fechaDespacho} - Operador: ${operadorMonitoreo} - Total: ${total}`,
        );

        if (!titulo) return;

        const btnGuardar = document.getElementById("guardar-informe-btn");
        const originalText = btnGuardar?.textContent;
        if (btnGuardar) {
          btnGuardar.textContent = "Guardando...";
          btnGuardar.disabled = true;
        }

        try {
          const payload = {
            titulo,
            fecha_despacho: fechaDespacho,
            total_despachos: total,
            a_tiempo: aTiempo,
            con_retraso: conRetraso,
            en_ruta: enRuta,
            programados,
            total_incidencias: totalIncidencias,
            operador_monitoreo: operadorMonitoreo,
            // Este campo es el que espera guardar_informe.php
            datos_informe: lastInformeData,
          };

          const res = await fetch(
            "/bitacora_/src/informe/guardar_informe.php",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            },
          );

          const text = await res.text();

          let data;
          try {
            data = JSON.parse(text);
          } catch (e) {
            throw new Error(
              `Respuesta inválida del servidor (no JSON). Inicio: ${text.substring(
                0,
                200,
              )}`,
            );
          }

          if (!res.ok || !data?.success) {
            throw new Error(data?.message || `Error HTTP ${res.status}`);
          }

          alert(`✅ Informe guardado correctamente (ID: ${data.id})`);
        } catch (error) {
          alert(`❌ Error al guardar en BD: ${error.message}`);
        } finally {
          if (btnGuardar) {
            btnGuardar.textContent = originalText || "Guardar Informe";
            btnGuardar.disabled = false;
          }
        }
      }
      let informesGuardadosCache = [];

      // Funciones helper
      function getNormalizedString(v) {
        return (v ?? "")
          .toString()
          .trim()
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "");
      }

      function parseInformeDate(value) {
        if (!value) return null;
        const s = value.toString().trim();
        if (!s) return null;
        const candidates = [
          dayjs(s, "YYYY-MM-DD", true),
          dayjs(s, "DD/MM/YYYY", true),
          dayjs(s, "YYYY-MM-DD HH:mm:ss", true),
          dayjs(s),
        ];
        return candidates.find((d) => d && d.isValid()) || null;
      }

      function setDbStatus(text) {
        const el = document.getElementById("db-status");
        if (el) el.textContent = text;
      }

      function setInformesFilterSummary(shown, total) {
        const el = document.getElementById("informes-filtro-resumen");
        if (!el) return;
        el.textContent = `Mostrando ${shown} de ${total}`;
      }

      function applyInformesFilters() {
        const container = document.getElementById("informes-lista-container");
        if (!container) return;

        const all = Array.isArray(informesGuardadosCache)
          ? informesGuardadosCache
          : [];

        const q = getNormalizedString(
          document.getElementById("informes-filtro-texto")?.value,
        );
        const unidadSel = (
          document.getElementById("informes-filtro-unidad")?.value ?? ""
        )
          .toString()
          .trim();
        const soloIncidencias = Boolean(
          document.getElementById("informes-filtro-solo-incidencias")?.checked,
        );
        const desde = parseInformeDate(
          document.getElementById("informes-filtro-fecha-desde")?.value,
        );
        const hasta = parseInformeDate(
          document.getElementById("informes-filtro-fecha-hasta")?.value,
        );

        const filtered = all.filter((inf) => {
          if (!inf) return false;

          if (q) {
            const haystack = [
              inf.id,
              inf.titulo,
              inf.operador_monitoreo,
              inf.fecha_despacho,
              ...(getUnidadesFromInforme(inf) || []),
            ]
              .map(getNormalizedString)
              .join(" ");
            if (!haystack.includes(q)) return false;
          }

          if (unidadSel) {
            const unidades = getUnidadesFromInforme(inf);
            if (!unidades.includes(unidadSel)) return false;
          }

          if (soloIncidencias) {
            const ti = parseInt(inf.total_incidencias, 10) || 0;
            if (ti <= 0) return false;
          }

          if (desde || hasta) {
            const d = parseInformeDate(inf.fecha_despacho);
            if (!d) return false;
            if (desde && d.isBefore(desde, "day")) return false;
            if (hasta && d.isAfter(hasta, "day")) return false;
          }

          return true;
        });

        setInformesFilterSummary(filtered.length, all.length);
        mostrarInformes(filtered, container);
      }

      function resetInformesFilters() {
        document.getElementById("informes-filtro-texto").value = "";
        document.getElementById("informes-filtro-fecha-desde").value = "";
        document.getElementById("informes-filtro-fecha-hasta").value = "";
        document.getElementById("informes-filtro-unidad").value = "";
        document.getElementById("informes-filtro-solo-incidencias").checked =
          false;
        applyInformesFilters();
      }

      function getUnidadesFromInforme(inf) {
        if (!inf) return [];
        let detalles = [];
        if (Array.isArray(inf.datos_informe_decoded)) {
          detalles = inf.datos_informe_decoded;
        } else if (inf.datos_informe) {
          try {
            const decoded = JSON.parse(inf.datos_informe);
            if (Array.isArray(decoded)) detalles = decoded;
          } catch (e) {
            console.warn('Error parsing datos_informe:', e);
          }
        }
        const unidades = detalles
          .map((d) => (d?.unidad ?? "").toString().trim())
          .filter(Boolean);
        return [...new Set(unidades)];
      }

      function populateUnidadInformeFilter(informes) {
        const sel = document.getElementById("informes-filtro-unidad");
        if (!sel) return;

        const current = (sel.value ?? "").toString();
        const allUnidades = new Set();
        
        (informes || []).forEach((inf) => {
          const unidades = getUnidadesFromInforme(inf);
          unidades.forEach((u) => allUnidades.add(u));
        });

        const unidadesArray = [...allUnidades].sort((a, b) => a.localeCompare(b));

        sel.innerHTML = '<option value="">Todas</option>';
        unidadesArray.forEach((unidad) => {
          const opt = document.createElement("option");
          opt.value = unidad;
          opt.textContent = unidad;
          sel.appendChild(opt);
        });

        sel.value = unidadesArray.includes(current) ? current : "";
      }

      async function cargarInformesGuardados() {
        const container = document.getElementById("informes-lista-container");
        if (!container) return;

        container.innerHTML = `
          <div class="text-center p-6">
            <p class="text-gray-500">Cargando informes guardados...</p>
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500 mt-2"></div>
          </div>
        `;

        try {
          const res = await fetch(
            "/bitacora_/src/informe/obtener_informes.php",
            {
              cache: "no-store",
            },
          );
          const text = await res.text();
          let data;
          try {
            data = JSON.parse(text);
          } catch (e) {
            throw new Error(
              `Respuesta inválida del servidor (no JSON). Inicio: ${text.substring(
                0,
                200,
              )}`,
            );
          }

          if (!res.ok) {
            throw new Error(data?.message || `Error HTTP ${res.status}`);
          }

          // Formato esperado: { success, data: [], count }
          if (data && data.success && Array.isArray(data.data)) {
            informesGuardadosCache = data.data;
            populateUnidadInformeFilter(informesGuardadosCache);
            applyInformesFilters();
          } else if (Array.isArray(data)) {
            // Compatibilidad si devuelve array directo
            informesGuardadosCache = data;
            populateUnidadInformeFilter(informesGuardadosCache);
            applyInformesFilters();
          } else {
            container.innerHTML = `
              <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg text-yellow-800">
                ${data?.message || "No se pudo cargar la lista de informes."}
              </div>
            `;
            informesGuardadosCache = [];
            setInformesFilterSummary(0, 0);
          }

          const status = document.getElementById("db-status");
          if (status)
            status.textContent =
              "Estado de la Base de Datos: Conectado (MySQL)";
        } catch (error) {
          container.innerHTML = `
            <div class="bg-red-50 border border-red-200 p-4 rounded-lg">
              <p class="text-red-800 font-semibold">Error al cargar informes</p>
              <p class="text-red-700 text-sm mt-1">${String(
                error.message || error,
              )}</p>
              <div class="mt-3 flex gap-2">
                <button onclick="cargarInformesGuardados()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Reintentar</button>
              </div>
            </div>
          `;
          const status = document.getElementById("db-status");
          if (status)
            status.textContent =
              "Estado de la Base de Datos: Error consultando MySQL";
        }
      }

      function mostrarInformes(informes, container) {
        if (!informes || informes.length === 0) {
          const total = Array.isArray(informesGuardadosCache)
            ? informesGuardadosCache.length
            : 0;
          setInformesFilterSummary(0, total);
          container.innerHTML = `
            <div class="text-center p-10 bg-gray-50 rounded-lg">
                <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <h3 class="text-lg font-medium text-gray-700">No hay informes guardados</h3>
                <p class="text-gray-500 mt-2">Los informes que guardes aparecerán aquí.</p>
                <p class="text-gray-400 text-sm mt-1">Ve a la pestaña "06. Informe Ejecutivo" para crear uno.</p>
            </div>
          `;
          return;
        }

        // Resumen
        try {
          const total = Array.isArray(informesGuardadosCache)
            ? informesGuardadosCache.length
            : informes.length;
          setInformesFilterSummary(informes.length, total);
        } catch (e) {}

        // Ordenar por fecha_creacion
        informes.sort((a, b) => {
          const dateA = new Date(a.fecha_creacion || 0);
          const dateB = new Date(b.fecha_creacion || 0);
          return dateB - dateA;
        });

        let html = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">`;

        informes.forEach((informe) => {
          const id = parseInt(informe.id, 10) || 0;
          const titulo = informe.titulo?.toString() || "Sin título";
          const fechaDespacho =
            informe.fecha_despacho?.toString() || "No especificada";
          const operador =
            informe.operador_monitoreo?.toString() || "No especificado";

          let fechaFormateada = "Fecha no disponible";
          try {
            let fechaObj;
            if (informe.fecha_creacion && informe.fecha_creacion.toDate) {
              fechaObj = informe.fecha_creacion.toDate();
            } else if (informe.fecha_creacion) {
              fechaObj = new Date(informe.fecha_creacion);
            }
            if (fechaObj && !isNaN(fechaObj.getTime())) {
              fechaFormateada = fechaObj.toLocaleString("es-MX", {
                year: "numeric",
                month: "long",
                day: "numeric",
                hour: "2-digit",
                minute: "2-digit",
              });
            }
          } catch (e) {
            console.warn("Error formateando fecha:", e);
          }

          const totalDespachos = parseInt(informe.total_despachos) || 0;
          const aTiempo = parseInt(informe.a_tiempo) || 0;
          const conRetraso = parseInt(informe.con_retraso) || 0;
          const totalIncidencias = parseInt(informe.total_incidencias) || 0;

          html += `
            <div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden hover:shadow-lg transition-shadow duration-300">
                <div class="p-5">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-bold text-lg text-blue-800 truncate" title="${titulo}">
                            ${titulo}
                        </h3>
                        <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded-full whitespace-nowrap">
                    ID: ${id || "N/A"}
                        </span>
                    </div>
                    <div class="flex items-center text-sm text-gray-500 mb-4">
                        <svg class="w-4 h-4 mr-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <span class="truncate">${fechaFormateada}</span>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-xs text-gray-500">Total Despachos</p>
                            <p class="text-lg font-bold">${totalDespachos}</p>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg">
                            <p class="text-xs text-gray-500">A Tiempo</p>
                            <p class="text-lg font-bold text-green-600">${aTiempo}</p>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg">
                            <p class="text-xs text-gray-500">Con Retraso</p>
                            <p class="text-lg font-bold text-red-600">${conRetraso}</p>
                        </div>
                        <div class="bg-yellow-50 p-3 rounded-lg">
                            <p class="text-xs text-gray-500">Incidencias</p>
                            <p class="text-lg font-bold text-yellow-600">${totalIncidencias}</p>
                        </div>
                    </div>
                    <div class="text-sm text-gray-600 mb-4 space-y-1">
                        <p class="truncate"><strong class="text-gray-700">Operador:</strong> ${operador}</p>
                        <p><strong class="text-gray-700">Fecha Despacho:</strong> ${fechaDespacho}</p>
                    </div>
                    <div class="flex space-x-2">
                      <button onclick="verInformeDetalle(${id})"
                                 class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm font-medium transition-colors duration-200">
                            Ver Detalle
                        </button>
                      <button onclick="eliminarInforme(${id})"
                                 class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 text-sm font-medium transition-colors duration-200"
                                title="Eliminar informe">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
          `;
        });

        html += `</div>`;
        container.innerHTML = html;
      }

      async function verInformeDetalle(id) {
        const numericId = parseInt(id, 10);
        if (!numericId || numericId <= 0)
          return alert("ID de informe inválido.");

        const body = document.getElementById("modal-informe-body");
        const title = document.getElementById("modal-informe-titulo");
        if (title) title.textContent = "Cargando...";
        if (body) {
          body.innerHTML = `
            <div class="text-center p-6">
              <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"></div>
              <p class="mt-2 text-gray-500">Cargando detalles...</p>
            </div>
          `;
        }
        openModal("modal-informe-detalle");

        try {
          const res = await fetch(
            `informe/obtener_informe_detalle.php?id=${encodeURIComponent(
              numericId,
            )}`,
            { cache: "no-store" },
          );
          const text = await res.text();
          let payload;
          try {
            payload = JSON.parse(text);
          } catch (e) {
            throw new Error(
              `Respuesta inválida del servidor (no JSON). Inicio: ${text.substring(
                0,
                200,
              )}`,
            );
          }
          if (!res.ok || !payload?.success)
            throw new Error(payload?.message || `Error HTTP ${res.status}`);

          const row = payload.data || {};
          if (title) title.textContent = `${row.titulo || "Informe"}`;

          let detalles = null;
          if (Array.isArray(row.datos_informe_decoded))
            detalles = row.datos_informe_decoded;
          else if (row.datos_informe) {
            try {
              const decoded = JSON.parse(row.datos_informe);
              if (Array.isArray(decoded)) detalles = decoded;
            } catch (e) {}
          }

          const resumenHtml = `
          <div class="space-y-2">
            <div class="bg-blue-50 border border-blue-100 rounded-lg p-4">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                <p><span class="font-medium text-gray-700">Fecha de creación:</span> ${escapeHtml(
                  row.fecha_creacion || "",
                )}</p>
                <p><span class="font-medium text-gray-700">Fecha de despacho:</span> ${escapeHtml(
                  row.fecha_despacho || "",
                )}</p>
                <p><span class="font-medium text-gray-700">Operador:</span> ${escapeHtml(
                  row.operador_monitoreo || "",
                )}</p>
              </div>

              <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-3">
                  <div class="bg-gray-100 p-4 rounded-lg text-center">
                    <p class="text-sm font-medium text-gray-600">Total Despachos</p>
                      <p class="text-2xl font-bold mt-1">${escapeHtml(
                        row.total_despachos || 0,
                      )}</p>
                  </div>
                  <div class="bg-green-100 p-4 rounded-lg text-center">
                    <p class="text-sm font-medium text-green-700">A Tiempo</p>
                    <p class="text-2xl font-bold text-green-800 mt-1">
                        ${escapeHtml(row.a_tiempo || 0)}
                    </p>
                  </div>
                  <div class="bg-red-100 p-4 rounded-lg text-center">
                    <p class="text-sm font-medium text-red-700">Con Retraso</p>
                    <p class="text-2xl font-bold text-red-800 mt-1">
                        ${escapeHtml(row.con_retraso || 0)}
                    </p>
                  </div>
                  <div class="bg-yellow-100 p-4 rounded-lg text-center">
                    <p class="text-sm font-medium text-yellow-700">Incidencias</p>
                    <p class="text-2xl font-bold text-yellow-800 mt-1">${escapeHtml(
                      row.total_incidencias || 0,
                    )}</p>
                  </div>
              </div>
            </div>
          </div>
          `;

          let detallesHtml = "";
          if (Array.isArray(detalles) && detalles.length) {
            const head = `
              <div class="overflow-x-auto rounded-xl border border-gray-200 mt-4">
                <table class="min-w-full text-sm">
                  <thead class="bg-gray-50 text-gray-700">
                    <tr>
                      <th class="text-left p-3">Folio</th>
                      <th class="text-left p-3">Unidad</th>
                      <th class="text-left p-3">Ruta</th>
                      <th class="text-left p-3">Estatus</th>
                      <th class="text-left p-3">Incidencias</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-100 bg-white">
            `;
            const rows = detalles
              .slice(0, 200)
              .map((d) => {
                const ruta = `${d.origen || ""} → ${d.destino || ""}`.trim();
                const inc = Array.isArray(d.incidencias)
                  ? d.incidencias.length
                  : 0;
                return `
                  <tr>
                    <td class="p-3 whitespace-nowrap">${escapeHtml(
                      d.folio || "",
                    )}</td>
                    <td class="p-3 whitespace-nowrap font-semibold">${escapeHtml(
                      d.unidad || "",
                    )}</td>
                    <td class="p-3">${escapeHtml(ruta)}</td>
                    <td class="p-3 whitespace-nowrap">${escapeHtml(
                      d.estatus || "",
                    )}</td>
                    <td class="p-3 whitespace-nowrap">${inc}</td>
                  </tr>
                `;
              })
              .join("");
            const foot = `</tbody></table></div>`;
            detallesHtml = `
              <h4 class="text-lg font-semibold text-gray-800 mt-6 mb-2">Detalle (primeros 200)</h4>
              ${head}${rows}${foot}
            `;
          }

          if (body) body.innerHTML = `${resumenHtml}${detallesHtml}`;
        } catch (err) {
          if (title) title.textContent = "Error";
          if (body)
            body.innerHTML = `
              <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-red-800">
                <strong>No se pudo cargar el detalle:</strong> ${escapeHtml(
                  String(err?.message || err),
                )}
              </div>
            `;
        }
      }

      async function eliminarInforme(id) {
        if (userRole !== "editor") {
          alert("No tienes permisos para eliminar informes.");
          return;
        }
        const numericId = parseInt(id, 10);
        if (!numericId || numericId <= 0)
          return alert("ID de informe inválido.");
        if (!confirm(`¿Eliminar el informe ID ${numericId}?`)) return;

        try {
          const res = await fetch(
            "/bitacora_/src/informe/eliminar_informe.php",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ id: numericId }),
            },
          );
          const text = await res.text();
          let payload;
          try {
            payload = JSON.parse(text);
          } catch (e) {
            throw new Error(
              `Respuesta inválida del servidor (no JSON). Inicio: ${text.substring(
                0,
                200,
              )}`,
            );
          }
          if (!res.ok || !payload?.success)
            throw new Error(payload?.message || `Error HTTP ${res.status}`);

          alert("Informe eliminado correctamente.");
          cargarInformesGuardados();
        } catch (err) {
          alert(`Error al eliminar: ${err?.message || err}`);
        }
      }

      /* ===========================
   INIT
=========================== */
      (function init() {
        // Siempre pedimos login para respetar roles, pero si hay sesión, la reusamos.
        try {
          const savedRole = sessionStorage.getItem("bitacoraUserRole");
          if (savedRole && USER_ROLES[savedRole]) setUserRole(savedRole);
        } catch (e) {}

        if (!userRole)
          document.getElementById("login-modal").classList.remove("hidden");
        loadDataFromGoogleSheets(true);
      })();
    </script>
  </body>
</html>
